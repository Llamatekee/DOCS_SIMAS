\begin{MintedVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{package}\PYG{+w}{ }\PYG{n+nn}{simulador}\PYG{p}{;}

\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{gramatica.Gramatica}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{gramatica.TablaPredictivaPaso5}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{gramatica.FuncionError}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.fxml.FXML}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.fxml.FXMLLoader}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.scene.Parent}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.scene.control.*}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.scene.layout.BorderPane}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.stage.Modality}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.stage.Stage}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.stage.FileChooser}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.scene.Scene}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.scene.layout.FlowPane}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.geometry.Insets}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.geometry.Pos}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{java.io.IOException}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.scene.layout.HBox}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.scene.layout.Priority}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.scene.layout.VBox}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.collections.FXCollections}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.collections.ObservableList}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{java.util.Stack}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{java.util.Arrays}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{java.util.List}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.beans.property.SimpleStringProperty}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{java.util.ArrayList}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.scene.control.Tab}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.scene.control.TabPane}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{java.io.File}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{utils.ActualizableTextos}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{utils.TabManager}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{java.util.ResourceBundle}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.application.Platform}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{java.util.Map}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{java.util.HashMap}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.scene.control.Label}\PYG{p}{;}

\PYG{k+kd}{public}\PYG{+w}{ }\PYG{k+kd}{class} \PYG{n+nc}{SimulacionFinal}\PYG{+w}{ }\PYG{k+kd}{extends}\PYG{+w}{ }\PYG{n}{BorderPane}\PYG{+w}{ }\PYG{k+kd}{implements}\PYG{+w}{ }\PYG{n}{ActualizableTextos}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{TextField}\PYG{+w}{ }\PYG{n}{campoEntrada}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Button}\PYG{+w}{ }\PYG{n}{btnIniciar}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Button}\PYG{+w}{ }\PYG{n}{btnPaso}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Button}\PYG{+w}{ }\PYG{n}{btnFinal}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Button}\PYG{+w}{ }\PYG{n}{btnRetroceso}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Button}\PYG{+w}{ }\PYG{n}{btnInicio}\PYG{p}{;}
\PYG{+w}{    }\PYG{c+c1}{// Las áreas de texto individuales se han eliminado, ahora solo usamos la tabla de historial}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Button}\PYG{+w}{ }\PYG{n}{btnEditarCadena}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Button}\PYG{+w}{ }\PYG{n}{btnDerivacion}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Button}\PYG{+w}{ }\PYG{n}{btnArbol}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Button}\PYG{+w}{ }\PYG{n}{btnGenerarInforme}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Label}\PYG{+w}{ }\PYG{n}{labelTitulo}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{TableView}\PYG{o}{\PYGZlt{}}\PYG{n}{HistorialPaso}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{tablaHistorial}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{TableColumn}\PYG{o}{\PYGZlt{}}\PYG{n}{HistorialPaso}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{colPaso}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{TableColumn}\PYG{o}{\PYGZlt{}}\PYG{n}{HistorialPaso}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{colPila}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{TableColumn}\PYG{o}{\PYGZlt{}}\PYG{n}{HistorialPaso}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{colEntrada}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{TableColumn}\PYG{o}{\PYGZlt{}}\PYG{n}{HistorialPaso}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{colAccion}\PYG{p}{;}
\PYG{+w}{    }\PYG{c+c1}{// Labels para internacionalización}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Label}\PYG{+w}{ }\PYG{n}{labelEntrada}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Label}\PYG{+w}{ }\PYG{n}{labelHistorial}\PYG{p}{;}

\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Gramatica}\PYG{+w}{ }\PYG{n}{gramatica}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{TablaPredictivaPaso5}\PYG{+w}{ }\PYG{n}{tablaPredictiva}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{TabPane}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{ResourceBundle}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{;}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{c+c1}{// Variables para el informe PDF (copiadas del paso 6)}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{List}\PYG{o}{\PYGZlt{}}\PYG{n}{FuncionError}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{funcionesError}\PYG{p}{;}

\PYG{+w}{    }\PYG{c+c1}{// Estado de la simulación}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Stack}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{pilaSimulacion}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{List}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{entradaSimulacion}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{pasoActual}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{boolean}\PYG{+w}{ }\PYG{n}{simulacionEnCurso}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{false}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{ObservableList}\PYG{o}{\PYGZlt{}}\PYG{n}{HistorialPaso}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{historialObservable}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{FXCollections}\PYG{p}{.}\PYG{n+na}{observableArrayList}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{c+c1}{// Lista para almacenar los estados anteriores}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{List}\PYG{o}{\PYGZlt{}}\PYG{n}{EstadoSimulacion}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{estadosAnteriores}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{ArrayList}\PYG{o}{\PYGZlt{}}\PYG{o}{\PYGZgt{}}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{c+c1}{// Flag para saber si ya se ha realizado al menos un paso}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{boolean}\PYG{+w}{ }\PYG{n}{seHaRealizadoAlMenosUnPaso}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{false}\PYG{p}{;}
\PYG{+w}{    }\PYG{c+c1}{// Flag para saber si estamos en un estado final (aceptación o error)}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{boolean}\PYG{+w}{ }\PYG{n}{estadoFinalAlcanzado}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{false}\PYG{p}{;}

\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{simuladorPadreId}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{grupoId}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numeroGrupo}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numeroInstancia}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{simulacionId}\PYG{p}{;}

\PYG{+w}{    }\PYG{c+c1}{// Referencias a pestañas hijas activas}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{derivacionTab}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{arbolTab}\PYG{p}{;}

\PYG{+w}{    }\PYG{c+c1}{// Clase para almacenar el estado de la simulación}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kd}{static}\PYG{+w}{ }\PYG{k+kd}{class} \PYG{n+nc}{EstadoSimulacion}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{Stack}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{pila}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{List}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{entrada}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{n+nf}{EstadoSimulacion}\PYG{p}{(}\PYG{n}{Stack}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{pila}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{List}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{entrada}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{accion}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{pila}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Stack}\PYG{o}{\PYGZlt{}}\PYG{o}{\PYGZgt{}}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{pila}\PYG{p}{.}\PYG{n+na}{addAll}\PYG{p}{(}\PYG{n}{pila}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{entrada}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{ArrayList}\PYG{o}{\PYGZlt{}}\PYG{o}{\PYGZgt{}}\PYG{p}{(}\PYG{n}{entrada}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+c1}{// Nodo para el árbol sintáctico}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kd}{static}\PYG{+w}{ }\PYG{k+kd}{class} \PYG{n+nc}{NodoArbol}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{valor}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{List}\PYG{o}{\PYGZlt{}}\PYG{n}{NodoArbol}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{hijos}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{ArrayList}\PYG{o}{\PYGZlt{}}\PYG{o}{\PYGZgt{}}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{NodoArbol}\PYG{p}{(}\PYG{n}{String}\PYG{+w}{ }\PYG{n}{valor}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{+w}{ }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{valor}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{valor}\PYG{p}{;}\PYG{+w}{ }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{n+nf}{SimulacionFinal}\PYG{p}{(}\PYG{n}{Gramatica}\PYG{+w}{ }\PYG{n}{gramatica}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{TablaPredictivaPaso5}\PYG{+w}{ }\PYG{n}{tablaPredictiva}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{TabPane}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{ResourceBundle}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{gramatica}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{gramatica}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{tablaPredictiva}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tablaPredictiva}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{tabPane}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{bundle}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Inicializar funciones de error para el informe PDF}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tablaPredictiva}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{funcionesError}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tablaPredictiva}\PYG{p}{.}\PYG{n+na}{getFuncionesError}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{c+c1}{// El simulacionId se asignará desde fuera (PanelNuevaSimDescPaso6)}
\PYG{+w}{        }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{simulacionId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Se asignará después}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Obtener el simulador padre de la pestaña actualmente seleccionada}
\PYG{+w}{        }\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{selectedTab}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getSelectionModel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getSelectedItem}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{selectedTab}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{selectedTab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }
\PYG{+w}{            }\PYG{n}{selectedTab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{startsWith}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulador\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{simuladorPadreId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{selectedTab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Contar simulaciones específicamente para este simulador y encontrar la última}
\PYG{+w}{        }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{simulacionesEnGrupo}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{tab}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{SimulacionFinal}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{SimulacionFinal}\PYG{+w}{ }\PYG{n}{otraSim}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{SimulacionFinal}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{otraSim}\PYG{p}{.}\PYG{n+na}{simuladorPadreId}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }
\PYG{+w}{                    }\PYG{n}{otraSim}\PYG{p}{.}\PYG{n+na}{simuladorPadreId}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{simuladorPadreId}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{simulacionesEnGrupo}\PYG{o}{+}\PYG{o}{+}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Añadir listener para cambios en las pestañas}
\PYG{+w}{        }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{addListener}\PYG{p}{(}\PYG{p}{(}\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{collections}\PYG{p}{.}\PYG{n+na}{ListChangeListener}\PYG{p}{.}\PYG{n+na}{Change}\PYG{o}{\PYGZlt{}}\PYG{o}{?}\PYG{+w}{ }\PYG{k+kd}{extends}\PYG{+w}{ }\PYG{n}{Tab}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{c}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{while}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{c}\PYG{p}{.}\PYG{n+na}{next}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{c}\PYG{p}{.}\PYG{n+na}{wasRemoved}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }\PYG{n}{c}\PYG{p}{.}\PYG{n+na}{wasAdded}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{c+c1}{// Actualizar el grupo y título cuando hay cambios en las pestañas}
\PYG{+w}{                    }\PYG{n}{actualizarGrupoYTitulo}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{n}{cargarFXML}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{actualizarTitulosPestañasInterno}\PYG{p}{(}\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{contarGruposActivos}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{simulacionesEnGrupo}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Añadir listener para cerrar pestañas hijas}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tabPane}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{addListener}\PYG{p}{(}\PYG{p}{(}\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{collections}\PYG{p}{.}\PYG{n+na}{ListChangeListener}\PYG{p}{.}\PYG{n+na}{Change}\PYG{o}{\PYGZlt{}}\PYG{o}{?}\PYG{+w}{ }\PYG{k+kd}{extends}\PYG{+w}{ }\PYG{n}{Tab}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{change}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{k}{while}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{change}\PYG{p}{.}\PYG{n+na}{next}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{change}\PYG{p}{.}\PYG{n+na}{wasRemoved}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{tab}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{change}\PYG{p}{.}\PYG{n+na}{getRemoved}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k}{this}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                }\PYG{c+c1}{// Cerrar las pestañas hijas usando TabManager}
\PYG{+w}{                                }\PYG{n}{Platform}\PYG{p}{.}\PYG{n+na}{runLater}\PYG{p}{(}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                    }\PYG{c+c1}{// Usar TabManager para cerrar las pestañas hijas}
\PYG{+w}{                                    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{simulacionId}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                        }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{closeChildTabs}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{simulacionId}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                                    }
\PYG{+w}{                                    }\PYG{c+c1}{// Reasignar números después de cerrar}
\PYG{+w}{                                    }\PYG{n}{reasignarNumerosSimulaciones}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                }\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Establece el ID de simulación desde fuera (usado por TabManager)}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{setSimulacionId}\PYG{p}{(}\PYG{n}{String}\PYG{+w}{ }\PYG{n}{simulacionId}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{simulacionId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{simulacionId}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Actualiza el grupo y título de la simulación basado en el estado actual del TabPane}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{actualizarGrupoYTitulo}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{simuladorPadreId}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Obtener el nuevo grupo y número del simulador padre}
\PYG{+w}{        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{nuevoGrupoId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{obtenerGrupoDeElemento}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{simuladorPadreId}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{nuevoNumeroGrupo}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{obtenerNumeroGrupo}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{simuladorPadreId}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k+kt}{boolean}\PYG{+w}{ }\PYG{n}{hayMultiplesGrupos}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{contarGruposActivos}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Actualizar los valores internos}
\PYG{+w}{        }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{grupoId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{nuevoGrupoId}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{numeroGrupo}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{nuevoNumeroGrupo}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Contar simulaciones en el mismo grupo para determinar si mostrar el número de instancia}
\PYG{+w}{        }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{simulacionesEnGrupo}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{contarSimulacionesEnGrupo}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k+kt}{boolean}\PYG{+w}{ }\PYG{n}{mostrarInstancia}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{simulacionesEnGrupo}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Forzar actualización de títulos}
\PYG{+w}{        }\PYG{n}{actualizarTitulosPestañas}\PYG{p}{(}\PYG{n}{nuevoNumeroGrupo}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{hayMultiplesGrupos}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{numeroInstancia}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{mostrarInstancia}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Actualiza los títulos de las pestañas con el número de grupo especificado.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{actualizarTitulosPestañas}\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numeroGrupo}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{boolean}\PYG{+w}{ }\PYG{n}{mostrarGrupo}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numeroInstancia}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{boolean}\PYG{+w}{ }\PYG{n}{mostrarInstancia}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{numeroGrupo}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{numeroGrupo}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{numeroInstancia}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{numeroInstancia}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{n}{actualizarTitulosPestañasInterno}\PYG{p}{(}\PYG{n}{mostrarGrupo}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{mostrarInstancia}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Actualiza los títulos de las pestañas usando el número de grupo actual.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{actualizarTitulosPestañas}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tabPane}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }\PYG{n}{simuladorPadreId}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{k+kt}{boolean}\PYG{+w}{ }\PYG{n}{hayMultiplesGrupos}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{contarGruposActivos}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}
\PYG{+w}{        }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{simulacionesEnGrupo}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{contarSimulacionesEnGrupo}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k+kt}{boolean}\PYG{+w}{ }\PYG{n}{mostrarInstancia}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{simulacionesEnGrupo}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{n}{actualizarTitulosPestañasInterno}\PYG{p}{(}\PYG{n}{hayMultiplesGrupos}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{mostrarInstancia}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Actualiza los títulos de las pestañas relacionadas con esta simulación.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{actualizarTitulosPestañasInterno}\PYG{p}{(}\PYG{k+kt}{boolean}\PYG{+w}{ }\PYG{n}{mostrarGrupo}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{boolean}\PYG{+w}{ }\PYG{n}{mostrarInstancia}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{c+c1}{// Buscar la pestaña de simulación y actualizarla}
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{tab}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{c+c1}{// Buscar por userData primero, luego por contenido como respaldo}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{p}{(}\PYG{n}{simulacionId}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }
\PYG{+w}{                 }\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{n}{simulacionId}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }
\PYG{+w}{                }\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k}{this}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }
\PYG{+w}{                }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{tituloBase}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{bundle}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{?}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.titulo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Simulación}\PYG{l+s}{\PYGZdq{}}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{nuevoTitulo}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{construirTitulo}\PYG{p}{(}\PYG{n}{tituloBase}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{mostrarGrupo}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{mostrarInstancia}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{nuevoTitulo}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{k}{break}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Las pestañas de derivación y árbol ahora se gestionan automáticamente por TabManager}
\PYG{+w}{        }\PYG{c+c1}{// No necesitamos actualizarlas manualmente aquí}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Construye el título de una pestaña basado en el estado actual.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n+nf}{construirTitulo}\PYG{p}{(}\PYG{n}{String}\PYG{+w}{ }\PYG{n}{tituloBase}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{boolean}\PYG{+w}{ }\PYG{n}{mostrarGrupo}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{boolean}\PYG{+w}{ }\PYG{n}{mostrarInstancia}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{StringBuilder}\PYG{+w}{ }\PYG{n}{titulo}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{StringBuilder}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{mostrarGrupo}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{titulo}\PYG{p}{.}\PYG{n+na}{append}\PYG{p}{(}\PYG{n}{numeroGrupo}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{append}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZhy{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{n}{titulo}\PYG{p}{.}\PYG{n+na}{append}\PYG{p}{(}\PYG{n}{tituloBase}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{mostrarInstancia}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{titulo}\PYG{p}{.}\PYG{n+na}{append}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{ (}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{append}\PYG{p}{(}\PYG{n}{numeroInstancia}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{append}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{)}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{resultado}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{titulo}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{resultado}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Reasigna los números de las simulaciones en orden secuencial.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{reasignarNumerosSimulaciones}\PYG{p}{(}\PYG{n}{TabPane}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tabPane}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }\PYG{n}{simuladorPadreId}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Agrupar simulaciones por simulador padre}
\PYG{+w}{        }\PYG{n}{Map}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{List}\PYG{o}{\PYGZlt{}}\PYG{n}{SimulacionFinal}\PYG{o}{\PYGZgt{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{simulacionesPorSimulador}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{HashMap}\PYG{o}{\PYGZlt{}}\PYG{o}{\PYGZgt{}}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Recolectar todas las simulaciones y agruparlas por simulador padre}
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{tab}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{SimulacionFinal}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{SimulacionFinal}\PYG{+w}{ }\PYG{n}{sim}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{SimulacionFinal}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{sim}\PYG{p}{.}\PYG{n+na}{simuladorPadreId}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{simulacionesPorSimulador}
\PYG{+w}{                        }\PYG{p}{.}\PYG{n+na}{computeIfAbsent}\PYG{p}{(}\PYG{n}{sim}\PYG{p}{.}\PYG{n+na}{simuladorPadreId}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{k}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{ArrayList}\PYG{o}{\PYGZlt{}}\PYG{o}{\PYGZgt{}}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{+w}{                        }\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{n}{sim}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Reasignar números para cada simulador}
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{List}\PYG{o}{\PYGZlt{}}\PYG{n}{SimulacionFinal}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{simulaciones}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{simulacionesPorSimulador}\PYG{p}{.}\PYG{n+na}{values}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{c+c1}{// Ordenar por posición en el TabPane para mantener el orden visual}
\PYG{+w}{            }\PYG{n}{simulaciones}\PYG{p}{.}\PYG{n+na}{sort}\PYG{p}{(}\PYG{p}{(}\PYG{n}{s1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{s2}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{pos1}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{indexOf}\PYG{p}{(}\PYG{n}{findTabForSimulacion}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{s1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{pos2}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{indexOf}\PYG{p}{(}\PYG{n}{findTabForSimulacion}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{s2}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{Integer}\PYG{p}{.}\PYG{n+na}{compare}\PYG{p}{(}\PYG{n}{pos1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pos2}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Reasignar números}
\PYG{+w}{            }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{n}{simulaciones}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{o}{+}\PYG{o}{+}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{SimulacionFinal}\PYG{+w}{ }\PYG{n}{sim}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{simulaciones}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{sim}\PYG{p}{.}\PYG{n+na}{setNumeroInstancia}\PYG{p}{(}\PYG{n}{i}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{sim}\PYG{p}{.}\PYG{n+na}{actualizarTitulosPestañas}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kd}{static}\PYG{+w}{ }\PYG{n}{Tab}\PYG{+w}{ }\PYG{n+nf}{findTabForSimulacion}\PYG{p}{(}\PYG{n}{TabPane}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{SimulacionFinal}\PYG{+w}{ }\PYG{n}{sim}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{tab}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{n}{sim}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{return}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{cargarFXML}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{try}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{FXMLLoader}\PYG{+w}{ }\PYG{n}{loader}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{FXMLLoader}\PYG{p}{(}\PYG{n}{getClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getResource}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{/vistas/SimulacionFinal.fxml}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{loader}\PYG{p}{.}\PYG{n+na}{setController}\PYG{p}{(}\PYG{k}{this}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{c+c1}{// Si tienes un bundle global, pásalo aquí:}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{bundle}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{loader}\PYG{p}{.}\PYG{n+na}{setResources}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{Parent}\PYG{+w}{ }\PYG{n}{root}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{loader}\PYG{p}{.}\PYG{n+na}{load}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{setCenter}\PYG{p}{(}\PYG{n}{root}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Aplicar estilos CSS específicos para la simulación}
\PYG{+w}{            }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{getStylesheets}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{n}{getClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getResource}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{/vistas/styles2.css}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{toExternalForm}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{n}{initialize}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}\PYG{+w}{ }
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{catch}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{IOException}\PYG{+w}{ }\PYG{n}{e}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{e}\PYG{p}{.}\PYG{n+na}{printStackTrace}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{n+nd}{@FXML}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{initialize}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{btnEditarCadena}\PYG{p}{.}\PYG{n+na}{setOnAction}\PYG{p}{(}\PYG{n}{e}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{mostrarDialogoEditarCadena}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnIniciar}\PYG{p}{.}\PYG{n+na}{setOnAction}\PYG{p}{(}\PYG{n}{e}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{iniciarSimulacionFinal}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnPaso}\PYG{p}{.}\PYG{n+na}{setOnAction}\PYG{p}{(}\PYG{n}{e}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{avanzarPaso}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnFinal}\PYG{p}{.}\PYG{n+na}{setOnAction}\PYG{p}{(}\PYG{n}{e}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{avanzarAlFinal}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnInicio}\PYG{p}{.}\PYG{n+na}{setOnAction}\PYG{p}{(}\PYG{n}{e}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{retrocederAlInicio}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnRetroceso}\PYG{p}{.}\PYG{n+na}{setOnAction}\PYG{p}{(}\PYG{n}{e}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{retrocederPaso}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnDerivacion}\PYG{p}{.}\PYG{n+na}{setOnAction}\PYG{p}{(}\PYG{n}{e}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{mostrarDerivacion}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnArbol}\PYG{p}{.}\PYG{n+na}{setOnAction}\PYG{p}{(}\PYG{n}{e}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{mostrarArbolSintactico}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnGenerarInforme}\PYG{p}{.}\PYG{n+na}{setOnAction}\PYG{p}{(}\PYG{n}{e}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{generarInforme}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Las áreas de texto individuales se han eliminado, ahora solo usamos la tabla de historial}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Inicializar tabla de historial}
\PYG{+w}{        }\PYG{n}{colPaso}\PYG{p}{.}\PYG{n+na}{setCellValueFactory}\PYG{p}{(}\PYG{n}{data}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{SimpleStringProperty}\PYG{p}{(}\PYG{n}{data}\PYG{p}{.}\PYG{n+na}{getValue}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getPaso}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{colPila}\PYG{p}{.}\PYG{n+na}{setCellValueFactory}\PYG{p}{(}\PYG{n}{data}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{SimpleStringProperty}\PYG{p}{(}\PYG{n}{data}\PYG{p}{.}\PYG{n+na}{getValue}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getPila}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{colEntrada}\PYG{p}{.}\PYG{n+na}{setCellValueFactory}\PYG{p}{(}\PYG{n}{data}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{SimpleStringProperty}\PYG{p}{(}\PYG{n}{data}\PYG{p}{.}\PYG{n+na}{getValue}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getEntrada}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{colAccion}\PYG{p}{.}\PYG{n+na}{setCellValueFactory}\PYG{p}{(}\PYG{n}{data}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{SimpleStringProperty}\PYG{p}{(}\PYG{n}{data}\PYG{p}{.}\PYG{n+na}{getValue}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getAccion}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{tablaHistorial}\PYG{p}{.}\PYG{n+na}{setItems}\PYG{p}{(}\PYG{n}{historialObservable}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{tablaHistorial}\PYG{p}{.}\PYG{n+na}{setColumnResizePolicy}\PYG{p}{(}\PYG{n}{TableView}\PYG{p}{.}\PYG{n+na}{CONSTRAINED\PYGZus{}RESIZE\PYGZus{}POLICY}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{c+c1}{// No mostrar mensaje de tabla vacía}
\PYG{+w}{        }\PYG{n}{tablaHistorial}\PYG{p}{.}\PYG{n+na}{setPlaceholder}\PYG{p}{(}\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Label}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Deshabilitar botones inicialmente}
\PYG{+w}{        }\PYG{n}{btnPaso}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnFinal}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnRetroceso}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnInicio}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnGenerarInforme}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Configurar lógica de habilitación de botones de navegación}
\PYG{+w}{        }\PYG{n}{configurarLogicaBotones}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Configura la lógica de habilitación/deshabilitación de los botones según el estado de la simulación}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{configurarLogicaBotones}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{c+c1}{// Los botones de retroceso deben estar deshabilitados inicialmente}
\PYG{+w}{        }\PYG{c+c1}{// Se habilitarán cuando haya estados anteriores para retroceder}
\PYG{+w}{        }\PYG{n}{actualizarEstadoBotonesNavegacion}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{actualizarEstadoBotonInforme}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Actualiza el estado de habilitación de los botones de navegación según el estado actual}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{actualizarEstadoBotonesNavegacion}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{c+c1}{// Los botones de retroceso deben estar habilitados solo si se ha realizado al menos un paso}
\PYG{+w}{        }\PYG{n}{btnRetroceso}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{o}{!}\PYG{n}{seHaRealizadoAlMenosUnPaso}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnInicio}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{o}{!}\PYG{n}{seHaRealizadoAlMenosUnPaso}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Actualiza el estado del botón de generar informe según si estamos en un estado final}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{actualizarEstadoBotonInforme}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{c+c1}{// El botón de informe solo debe estar habilitado si estamos en un estado final}
\PYG{+w}{        }\PYG{n}{btnGenerarInforme}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{o}{!}\PYG{n}{estadoFinalAlcanzado}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{mostrarDialogoEditarCadena}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{Stage}\PYG{+w}{ }\PYG{n}{dialog}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Stage}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{dialog}\PYG{p}{.}\PYG{n+na}{initModality}\PYG{p}{(}\PYG{n}{Modality}\PYG{p}{.}\PYG{n+na}{APPLICATION\PYGZus{}MODAL}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{dialog}\PYG{p}{.}\PYG{n+na}{setTitle}\PYG{p}{(}\PYG{n}{bundle}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{?}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.dialog.editar.titulo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Editar cadena de entrada}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Crear contenedor principal con estilo moderno y tamaño más pequeño}
\PYG{+w}{        }\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{VBox}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{setAlignment}\PYG{p}{(}\PYG{n}{Pos}\PYG{p}{.}\PYG{n+na}{CENTER}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{setPadding}\PYG{p}{(}\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Insets}\PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{dialog\PYGZhy{}container}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Header del diálogo}
\PYG{+w}{        }\PYG{n}{Label}\PYG{+w}{ }\PYG{n}{headerLabel}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Label}\PYG{p}{(}\PYG{n}{bundle}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{?}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.dialog.editar.instruccion}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }
\PYG{+w}{                                    }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Haz clic en los terminales para construir la cadena de entrada:}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{headerLabel}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{dialog\PYGZhy{}header}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{headerLabel}\PYG{p}{.}\PYG{n+na}{setWrapText}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{headerLabel}\PYG{p}{.}\PYG{n+na}{setAlignment}\PYG{p}{(}\PYG{n}{Pos}\PYG{p}{.}\PYG{n+na}{CENTER}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Panel de terminales con estilo moderno}
\PYG{+w}{        }\PYG{n}{FlowPane}\PYG{+w}{ }\PYG{n}{terminalPane}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{FlowPane}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{terminalPane}\PYG{p}{.}\PYG{n+na}{setHgap}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{terminalPane}\PYG{p}{.}\PYG{n+na}{setVgap}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{terminalPane}\PYG{p}{.}\PYG{n+na}{setPadding}\PYG{p}{(}\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Insets}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{terminalPane}\PYG{p}{.}\PYG{n+na}{setAlignment}\PYG{p}{(}\PYG{n}{Pos}\PYG{p}{.}\PYG{n+na}{CENTER}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{terminalPane}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{dialog\PYGZhy{}content}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{n}{StringBuilder}\PYG{+w}{ }\PYG{n}{cadenaActual}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{StringBuilder}\PYG{p}{(}\PYG{n}{campoEntrada}\PYG{p}{.}\PYG{n+na}{getText}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Campo de texto con estilo moderno}
\PYG{+w}{        }\PYG{n}{TextField}\PYG{+w}{ }\PYG{n}{campoCadena}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{TextField}\PYG{p}{(}\PYG{n}{cadenaActual}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{campoCadena}\PYG{p}{.}\PYG{n+na}{setEditable}\PYG{p}{(}\PYG{k+kc}{false}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{campoCadena}\PYG{p}{.}\PYG{n+na}{setPrefWidth}\PYG{p}{(}\PYG{l+m+mi}{280}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{campoCadena}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{dialog\PYGZhy{}field}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Botones de terminales más pequeños}
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kd}{var}\PYG{+w}{ }\PYG{n}{terminal}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{gramatica}\PYG{p}{.}\PYG{n+na}{getTerminales}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{Button}\PYG{+w}{ }\PYG{n}{btn}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Button}\PYG{p}{(}\PYG{n}{terminal}\PYG{p}{.}\PYG{n+na}{getNombre}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{btn}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{dialog\PYGZhy{}button}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{btn}\PYG{p}{.}\PYG{n+na}{setMinWidth}\PYG{p}{(}\PYG{l+m+mi}{60}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{btn}\PYG{p}{.}\PYG{n+na}{setPrefWidth}\PYG{p}{(}\PYG{l+m+mi}{60}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{btn}\PYG{p}{.}\PYG{n+na}{setMinHeight}\PYG{p}{(}\PYG{l+m+mi}{35}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{btn}\PYG{p}{.}\PYG{n+na}{setPrefHeight}\PYG{p}{(}\PYG{l+m+mi}{35}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{btn}\PYG{p}{.}\PYG{n+na}{setOnAction}\PYG{p}{(}\PYG{n}{ev}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{cadenaActual}\PYG{p}{.}\PYG{n+na}{length}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{cadenaActual}\PYG{p}{.}\PYG{n+na}{append}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{ }\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{cadenaActual}\PYG{p}{.}\PYG{n+na}{append}\PYG{p}{(}\PYG{n}{terminal}\PYG{p}{.}\PYG{n+na}{getNombre}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{campoCadena}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{cadenaActual}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{terminalPane}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{n}{btn}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}

\PYG{+w}{        }\PYG{c+c1}{// Botón para borrar último}
\PYG{+w}{        }\PYG{n}{Button}\PYG{+w}{ }\PYG{n}{btnBorrar}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Button}\PYG{p}{(}\PYG{n}{bundle}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{?}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.btn.borrar.ultimo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Borrar último}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnBorrar}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{button\PYGZhy{}cancel}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnBorrar}\PYG{p}{.}\PYG{n+na}{setMinWidth}\PYG{p}{(}\PYG{l+m+mi}{120}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnBorrar}\PYG{p}{.}\PYG{n+na}{setPrefWidth}\PYG{p}{(}\PYG{l+m+mi}{120}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnBorrar}\PYG{p}{.}\PYG{n+na}{setOnAction}\PYG{p}{(}\PYG{n}{ev}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{String}\PYG{o}{[}\PYG{o}{]}\PYG{+w}{ }\PYG{n}{partes}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{campoCadena}\PYG{p}{.}\PYG{n+na}{getText}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{trim}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{split}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{ }\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{partes}\PYG{p}{.}\PYG{n+na}{length}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{o}{!}\PYG{n}{campoCadena}\PYG{p}{.}\PYG{n+na}{getText}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{trim}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{isEmpty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{cadenaActual}\PYG{p}{.}\PYG{n+na}{setLength}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{n}{partes}\PYG{p}{.}\PYG{n+na}{length}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{o}{+}\PYG{o}{+}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{i}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{cadenaActual}\PYG{p}{.}\PYG{n+na}{append}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{ }\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{n}{cadenaActual}\PYG{p}{.}\PYG{n+na}{append}\PYG{p}{(}\PYG{n}{partes}\PYG{o}{[}\PYG{n}{i}\PYG{o}{]}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                }\PYG{n}{campoCadena}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{cadenaActual}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Botón aceptar}
\PYG{+w}{        }\PYG{n}{Button}\PYG{+w}{ }\PYG{n}{btnAceptar}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Button}\PYG{p}{(}\PYG{n}{bundle}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{?}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{button.aceptar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Aceptar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnAceptar}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{button\PYGZhy{}finish}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnAceptar}\PYG{p}{.}\PYG{n+na}{setMinWidth}\PYG{p}{(}\PYG{l+m+mi}{120}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnAceptar}\PYG{p}{.}\PYG{n+na}{setPrefWidth}\PYG{p}{(}\PYG{l+m+mi}{120}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnAceptar}\PYG{p}{.}\PYG{n+na}{setOnAction}\PYG{p}{(}\PYG{n}{ev}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{campoEntrada}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{campoCadena}\PYG{p}{.}\PYG{n+na}{getText}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{dialog}\PYG{p}{.}\PYG{n+na}{close}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Botón cancelar}
\PYG{+w}{        }\PYG{n}{Button}\PYG{+w}{ }\PYG{n}{btnCancelar}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Button}\PYG{p}{(}\PYG{n}{bundle}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{?}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{button.cancelar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Cancelar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnCancelar}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{button\PYGZhy{}cancel}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnCancelar}\PYG{p}{.}\PYG{n+na}{setMinWidth}\PYG{p}{(}\PYG{l+m+mi}{120}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnCancelar}\PYG{p}{.}\PYG{n+na}{setPrefWidth}\PYG{p}{(}\PYG{l+m+mi}{120}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnCancelar}\PYG{p}{.}\PYG{n+na}{setOnAction}\PYG{p}{(}\PYG{n}{ev}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{dialog}\PYG{p}{.}\PYG{n+na}{close}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Contenedor de acciones con estilo moderno}
\PYG{+w}{        }\PYG{n}{HBox}\PYG{+w}{ }\PYG{n}{acciones}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{HBox}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{acciones}\PYG{p}{.}\PYG{n+na}{setAlignment}\PYG{p}{(}\PYG{n}{Pos}\PYG{p}{.}\PYG{n+na}{CENTER}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{acciones}\PYG{p}{.}\PYG{n+na}{setPadding}\PYG{p}{(}\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Insets}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{acciones}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{dialog\PYGZhy{}actions}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{acciones}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{addAll}\PYG{p}{(}\PYG{n}{btnBorrar}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{btnAceptar}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{btnCancelar}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Agregar elementos al contenedor principal}
\PYG{+w}{        }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{addAll}\PYG{p}{(}\PYG{n}{headerLabel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{terminalPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{campoCadena}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{acciones}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{n}{Scene}\PYG{+w}{ }\PYG{n}{scene}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Scene}\PYG{p}{(}\PYG{n}{mainContainer}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{scene}\PYG{p}{.}\PYG{n+na}{getStylesheets}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{n}{getClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getResource}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{/vistas/styles2.css}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{toExternalForm}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{dialog}\PYG{p}{.}\PYG{n+na}{setScene}\PYG{p}{(}\PYG{n}{scene}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{dialog}\PYG{p}{.}\PYG{n+na}{setResizable}\PYG{p}{(}\PYG{k+kc}{false}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Obtener la ventana padre (la ventana principal de la aplicación)}
\PYG{+w}{        }\PYG{n}{Stage}\PYG{+w}{ }\PYG{n}{parentStage}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Stage}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{getScene}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getWindow}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Crear listeners reutilizables}
\PYG{+w}{        }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{beans}\PYG{p}{.}\PYG{n+na}{value}\PYG{p}{.}\PYG{n+na}{ChangeListener}\PYG{o}{\PYGZlt{}}\PYG{n}{Number}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{xListener}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{obs}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{oldVal}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{newVal}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{centrarDialogoEnVentanaPadre}\PYG{p}{(}\PYG{n}{dialog}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{parentStage}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{beans}\PYG{p}{.}\PYG{n+na}{value}\PYG{p}{.}\PYG{n+na}{ChangeListener}\PYG{o}{\PYGZlt{}}\PYG{n}{Number}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{yListener}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{obs}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{oldVal}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{newVal}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{centrarDialogoEnVentanaPadre}\PYG{p}{(}\PYG{n}{dialog}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{parentStage}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Agregar listeners para mantener el diálogo centrado cuando se mueva la ventana padre}
\PYG{+w}{        }\PYG{n}{parentStage}\PYG{p}{.}\PYG{n+na}{xProperty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{addListener}\PYG{p}{(}\PYG{n}{xListener}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{parentStage}\PYG{p}{.}\PYG{n+na}{yProperty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{addListener}\PYG{p}{(}\PYG{n}{yListener}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Mostrar el diálogo y luego centrarlo una vez que tenga dimensiones}
\PYG{+w}{        }\PYG{n}{dialog}\PYG{p}{.}\PYG{n+na}{show}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Centrar el diálogo después de que se haya mostrado y tenga dimensiones}
\PYG{+w}{        }\PYG{n}{Platform}\PYG{p}{.}\PYG{n+na}{runLater}\PYG{p}{(}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{centrarDialogoEnVentanaPadre}\PYG{p}{(}\PYG{n}{dialog}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{parentStage}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Limpiar los listeners cuando se cierre el diálogo}
\PYG{+w}{        }\PYG{n}{dialog}\PYG{p}{.}\PYG{n+na}{setOnHidden}\PYG{p}{(}\PYG{n}{e}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{parentStage}\PYG{p}{.}\PYG{n+na}{xProperty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{removeListener}\PYG{p}{(}\PYG{n}{xListener}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{parentStage}\PYG{p}{.}\PYG{n+na}{yProperty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{removeListener}\PYG{p}{(}\PYG{n}{yListener}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{iniciarSimulacionFinal}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{c+c1}{// Limpiar el historial y estados anteriores}
\PYG{+w}{        }\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{clear}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{estadosAnteriores}\PYG{p}{.}\PYG{n+na}{clear}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{pasoActual}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{seHaRealizadoAlMenosUnPaso}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{false}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{estadoFinalAlcanzado}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{false}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Limpiar el historial (las áreas de texto individuales se han eliminado)}

\PYG{+w}{        }\PYG{c+c1}{// Inicializar la pila con el símbolo inicial y el marcador de fin}
\PYG{+w}{        }\PYG{n}{pilaSimulacion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Stack}\PYG{o}{\PYGZlt{}}\PYG{o}{\PYGZgt{}}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{pilaSimulacion}\PYG{p}{.}\PYG{n+na}{push}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZdl{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{pilaSimulacion}\PYG{p}{.}\PYG{n+na}{push}\PYG{p}{(}\PYG{n}{gramatica}\PYG{p}{.}\PYG{n+na}{getSimbInicial}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Preparar la entrada}
\PYG{+w}{        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{entrada}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{campoEntrada}\PYG{p}{.}\PYG{n+na}{getText}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{trim}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{entrada}\PYG{p}{.}\PYG{n+na}{isEmpty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{mostrarAlertaCadenaVacia}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}

\PYG{+w}{        }\PYG{c+c1}{// Convertir la entrada en una lista de símbolos y añadir el marcador de fin}
\PYG{+w}{        }\PYG{n}{entradaSimulacion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{Arrays}\PYG{p}{.}\PYG{n+na}{asList}\PYG{p}{(}\PYG{n}{entrada}\PYG{p}{.}\PYG{n+na}{split}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZbs{}\PYGZbs{}}\PYG{l+s}{s+}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{List}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{entradaConFin}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{ArrayList}\PYG{o}{\PYGZlt{}}\PYG{o}{\PYGZgt{}}\PYG{p}{(}\PYG{n}{entradaSimulacion}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{entradaConFin}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZdl{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{entradaSimulacion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{entradaConFin}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Guardar el estado inicial antes de comenzar la simulación}
\PYG{+w}{        }\PYG{n}{estadosAnteriores}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{k}{new}\PYG{+w}{ }\PYG{n}{EstadoSimulacion}\PYG{p}{(}\PYG{n}{pilaSimulacion}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{entradaSimulacion}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.accion.inicio}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Iniciar la simulación}
\PYG{+w}{        }\PYG{n}{simulacionEnCurso}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{true}\PYG{p}{;}
\PYG{+w}{        }\PYG{c+c1}{// El botón Iniciar siempre debe estar activo}
\PYG{+w}{        }\PYG{n}{btnIniciar}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{false}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnPaso}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{false}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnFinal}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{false}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{campoEntrada}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnEditarCadena}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{false}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnGenerarInforme}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Deshabilitar botón al iniciar nueva simulación}

\PYG{+w}{        }\PYG{c+c1}{// Actualizar estado de botones de navegación e informe (deben estar deshabilitados al inicio)}
\PYG{+w}{        }\PYG{n}{actualizarEstadoBotonesNavegacion}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{actualizarEstadoBotonInforme}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Actualizar la vista}
\PYG{+w}{        }\PYG{n}{actualizarVista}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Resetear las pestañas hijas al estado inicial si están activas}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{derivacionTab}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{contains}\PYG{p}{(}\PYG{n}{derivacionTab}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{VBox}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{derivacionTab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{VBox}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// El segundo elemento es el contentContainer}
\PYG{+w}{            }\PYG{n}{ListView}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{listaDerivacion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{ListView}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n+nd}{@SuppressWarnings}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{unchecked}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}
\PYG{+w}{                }\PYG{n}{ListView}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{tempList}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{ListView}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{listaDerivacion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tempList}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}

\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{listaDerivacion}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{c+c1}{// Resetear la lista con solo el símbolo inicial}
\PYG{+w}{                }\PYG{n}{ObservableList}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{itemsDerivacion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{FXCollections}\PYG{p}{.}\PYG{n+na}{observableArrayList}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{itemsDerivacion}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.derivacion.iniciar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{listaDerivacion}\PYG{p}{.}\PYG{n+na}{setItems}\PYG{p}{(}\PYG{n}{itemsDerivacion}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}

\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{arbolTab}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{contains}\PYG{p}{(}\PYG{n}{arbolTab}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{c+c1}{// Crear árbol con solo el nodo inicial}
\PYG{+w}{            }\PYG{n}{NodoArbol}\PYG{+w}{ }\PYG{n}{raiz}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{NodoArbol}\PYG{p}{(}\PYG{n}{gramatica}\PYG{p}{.}\PYG{n+na}{getSimbInicial}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Generar el código DOT para Graphviz}
\PYG{+w}{            }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{dotCode}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{generarDotDesdeArbol}\PYG{p}{(}\PYG{n}{raiz}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{k}{try}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{c+c1}{// Crear un archivo temporal para el código DOT}
\PYG{+w}{                }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Path}\PYG{+w}{ }\PYG{n}{dotFile}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Files}\PYG{p}{.}\PYG{n+na}{createTempFile}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{arbol\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{.dot}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Files}\PYG{p}{.}\PYG{n+na}{write}\PYG{p}{(}\PYG{n}{dotFile}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{dotCode}\PYG{p}{.}\PYG{n+na}{getBytes}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }
\PYG{+w}{                }\PYG{c+c1}{// Crear un archivo temporal para la imagen}
\PYG{+w}{                }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Path}\PYG{+w}{ }\PYG{n}{imgFile}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Files}\PYG{p}{.}\PYG{n+na}{createTempFile}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{arbol\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{.png}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }
\PYG{+w}{                }\PYG{c+c1}{// Ejecutar Graphviz para generar la imagen}
\PYG{+w}{                }\PYG{n}{ProcessBuilder}\PYG{+w}{ }\PYG{n}{pb}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{ProcessBuilder}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{dot}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZhy{}Tpng}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{dotFile}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZhy{}o}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{imgFile}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{Process}\PYG{+w}{ }\PYG{n}{process}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{pb}\PYG{p}{.}\PYG{n+na}{start}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{process}\PYG{p}{.}\PYG{n+na}{waitFor}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }
\PYG{+w}{                }\PYG{c+c1}{// Cargar la imagen en un ImageView}
\PYG{+w}{                }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{image}\PYG{p}{.}\PYG{n+na}{Image}\PYG{+w}{ }\PYG{n}{imagen}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{image}\PYG{p}{.}\PYG{n+na}{Image}\PYG{p}{(}\PYG{n}{imgFile}\PYG{p}{.}\PYG{n+na}{toUri}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{image}\PYG{p}{.}\PYG{n+na}{ImageView}\PYG{+w}{ }\PYG{n}{imageView}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{image}\PYG{p}{.}\PYG{n+na}{ImageView}\PYG{p}{(}\PYG{n}{imagen}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{imageView}\PYG{p}{.}\PYG{n+na}{setPreserveRatio}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{imageView}\PYG{p}{.}\PYG{n+na}{setFitWidth}\PYG{p}{(}\PYG{l+m+mi}{800}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }
\PYG{+w}{                }\PYG{c+c1}{// Obtener el contenedor VBox existente y navegar a través de la jerarquía}
\PYG{+w}{                }\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{VBox}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{arbolTab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{                }\PYG{c+c1}{// La estructura es: mainContainer \PYGZhy{}\PYGZgt{} [headerLabel, contentContainer]}
\PYG{+w}{                }\PYG{c+c1}{// contentContainer \PYGZhy{}\PYGZgt{} [descriptionLabel, scrollPane, controlsContainer]}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{VBox}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// contentContainer}

\PYG{+w}{                    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                        }\PYG{n}{ScrollPane}\PYG{+w}{ }\PYG{n}{scrollPane}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{ScrollPane}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// scrollPane}

\PYG{+w}{                        }\PYG{c+c1}{// Actualizar el contenido del ScrollPane}
\PYG{+w}{                        }\PYG{n}{scrollPane}\PYG{p}{.}\PYG{n+na}{setContent}\PYG{p}{(}\PYG{n}{imageView}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{                        }\PYG{c+c1}{// Limpiar archivos temporales}
\PYG{+w}{                        }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Files}\PYG{p}{.}\PYG{n+na}{deleteIfExists}\PYG{p}{(}\PYG{n}{dotFile}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Files}\PYG{p}{.}\PYG{n+na}{deleteIfExists}\PYG{p}{(}\PYG{n}{imgFile}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                        }\PYG{n}{System}\PYG{p}{.}\PYG{n+na}{err}\PYG{p}{.}\PYG{n+na}{println}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Error: No se encontró el ScrollPane en la estructura esperada}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{System}\PYG{p}{.}\PYG{n+na}{err}\PYG{p}{.}\PYG{n+na}{println}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Error: Estructura del contenedor no es la esperada}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                }
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{catch}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Exception}\PYG{+w}{ }\PYG{n}{e}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{e}\PYG{p}{.}\PYG{n+na}{printStackTrace}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{mostrarAlertaCadenaVacia}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{Alert}\PYG{+w}{ }\PYG{n}{alert}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Alert}\PYG{p}{(}\PYG{n}{Alert}\PYG{p}{.}\PYG{n+na}{AlertType}\PYG{p}{.}\PYG{n+na}{WARNING}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setTitle}\PYG{p}{(}\PYG{n}{bundle}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{?}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.alert.cadena.vacia.titulo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Cadena de entrada vacía}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setHeaderText}\PYG{p}{(}\PYG{k+kc}{null}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setContentText}\PYG{p}{(}\PYG{n}{bundle}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{?}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.alert.cadena.vacia.mensaje}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Introduce una cadena de entrada válida antes de iniciar la simulación.}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Aplicar estilos modernos al diálogo}
\PYG{+w}{        }\PYG{n}{DialogPane}\PYG{+w}{ }\PYG{n}{dialogPane}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{getDialogPane}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{dialogPane}\PYG{p}{.}\PYG{n+na}{getStylesheets}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{n}{getClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getResource}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{/vistas/styles2.css}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{toExternalForm}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{dialogPane}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{wizard\PYGZhy{}step}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{showAndWait}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{avanzarPaso}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{o}{!}\PYG{n}{simulacionEnCurso}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{pilaSimulacion}\PYG{p}{.}\PYG{n+na}{isEmpty}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }\PYG{n}{entradaSimulacion}\PYG{p}{.}\PYG{n+na}{isEmpty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Guardar estado actual antes de modificarlo}
\PYG{+w}{        }\PYG{n}{estadosAnteriores}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{k}{new}\PYG{+w}{ }\PYG{n}{EstadoSimulacion}\PYG{p}{(}\PYG{n}{pilaSimulacion}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{entradaSimulacion}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Marcar que se ha realizado al menos un paso}
\PYG{+w}{        }\PYG{n}{seHaRealizadoAlMenosUnPaso}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{true}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Actualizar estado de botones de navegación después de guardar el estado}
\PYG{+w}{        }\PYG{n}{actualizarEstadoBotonesNavegacion}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{cimaPila}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{pilaSimulacion}\PYG{p}{.}\PYG{n+na}{peek}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{simboloEntrada}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{entradaSimulacion}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{accionRealizada}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Caso de aceptación}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{cimaPila}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZdl{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{simboloEntrada}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZdl{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{accionRealizada}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.accion.aceptar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{simulacionEnCurso}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{false}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{estadoFinalAlcanzado}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{true}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{btnPaso}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{btnFinal}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{actualizarEstadoBotonInforme}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Actualizar botón de informe}
\PYG{+w}{            }\PYG{n}{pasoActual}\PYG{o}{+}\PYG{o}{+}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{agregarPasoHistorial}\PYG{p}{(}\PYG{n}{accionRealizada}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{actualizarVista}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{actualizarPestañasHijas}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}

\PYG{+w}{        }\PYG{c+c1}{// Si son iguales y terminales, consumir}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{cimaPila}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{n}{simboloEntrada}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{pilaSimulacion}\PYG{p}{.}\PYG{n+na}{pop}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{entradaSimulacion}\PYG{p}{.}\PYG{n+na}{remove}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{accionRealizada}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.accion.emparejar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{esTerminal}\PYG{p}{(}\PYG{n}{cimaPila}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{c+c1}{// Error: terminal en pila distinto de entrada}
\PYG{+w}{            }\PYG{n}{accionRealizada}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.accion.error}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{simulacionEnCurso}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{false}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{estadoFinalAlcanzado}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{true}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{btnPaso}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{btnFinal}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{actualizarEstadoBotonInforme}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Actualizar botón de informe}
\PYG{+w}{            }\PYG{n}{pasoActual}\PYG{o}{+}\PYG{o}{+}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{agregarPasoHistorial}\PYG{p}{(}\PYG{n}{accionRealizada}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{actualizarVista}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{actualizarPestañasHijas}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{c+c1}{// Buscar producción o función de error en la tabla predictiva}
\PYG{+w}{            }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{accion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{buscarAccionTabla}\PYG{p}{(}\PYG{n}{cimaPila}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{simboloEntrada}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{accion}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }\PYG{n}{accion}\PYG{p}{.}\PYG{n+na}{isEmpty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{accionRealizada}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.accion.error}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{simulacionEnCurso}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{false}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{estadoFinalAlcanzado}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{true}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{btnPaso}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{btnFinal}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{actualizarEstadoBotonInforme}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Actualizar botón de informe}
\PYG{+w}{                }\PYG{n}{pasoActual}\PYG{o}{+}\PYG{o}{+}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{agregarPasoHistorial}\PYG{p}{(}\PYG{n}{accionRealizada}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{actualizarVista}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{actualizarPestañasHijas}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{accion}\PYG{p}{.}\PYG{n+na}{startsWith}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{E}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{accionRealizada}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{accion}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{accion}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{ε}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }\PYG{n}{accion}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{ε\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{pilaSimulacion}\PYG{p}{.}\PYG{n+na}{pop}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{accionRealizada}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{cimaPila}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{ → ε}\PYG{l+s}{\PYGZdq{}}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{c+c1}{// Es una producción, ejemplo: \PYGZdq{}3. D → T L;\PYGZdq{}}
\PYG{+w}{                }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{produccion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{accion}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{pilaSimulacion}\PYG{p}{.}\PYG{n+na}{pop}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{c+c1}{// Extraer la parte derecha de la producción}
\PYG{+w}{                }\PYG{n}{String}\PYG{o}{[}\PYG{o}{]}\PYG{+w}{ }\PYG{n}{partes}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{produccion}\PYG{p}{.}\PYG{n+na}{split}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{→}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{partes}\PYG{p}{.}\PYG{n+na}{length}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{derecha}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{partes}\PYG{o}{[}\PYG{l+m+mi}{1}\PYG{o}{]}\PYG{p}{.}\PYG{n+na}{trim}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{o}{!}\PYG{n}{derecha}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{ε}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                        }\PYG{n}{String}\PYG{o}{[}\PYG{o}{]}\PYG{+w}{ }\PYG{n}{simbolos}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{derecha}\PYG{p}{.}\PYG{n+na}{split}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{ }\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }\PYG{c+c1}{// Apilar de derecha a izquierda}
\PYG{+w}{                        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{simbolos}\PYG{p}{.}\PYG{n+na}{length}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZhy{}}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{o}{!}\PYG{n}{simbolos}\PYG{o}{[}\PYG{n}{i}\PYG{o}{]}\PYG{p}{.}\PYG{n+na}{isEmpty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{pilaSimulacion}\PYG{p}{.}\PYG{n+na}{push}\PYG{p}{(}\PYG{n}{simbolos}\PYG{o}{[}\PYG{n}{i}\PYG{o}{]}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                    }\PYG{n}{accionRealizada}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{produccion}\PYG{p}{.}\PYG{n+na}{trim}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{accionRealizada}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.accion.error}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{n}{pasoActual}\PYG{o}{+}\PYG{o}{+}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{agregarPasoHistorial}\PYG{p}{(}\PYG{n}{accionRealizada}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{actualizarVista}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{actualizarPestañasHijas}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{avanzarAlFinal}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{while}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{simulacionEnCurso}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{avanzarPaso}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{n}{actualizarPestañasHijas}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{retrocederAlInicio}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{o}{!}\PYG{n}{seHaRealizadoAlMenosUnPaso}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }\PYG{n}{estadosAnteriores}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{c+c1}{// Ya estamos en el inicio}
\PYG{+w}{            }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}

\PYG{+w}{        }\PYG{c+c1}{// Mantener solo el estado inicial}
\PYG{+w}{        }\PYG{n}{EstadoSimulacion}\PYG{+w}{ }\PYG{n}{estadoInicial}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{estadosAnteriores}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{estadosAnteriores}\PYG{p}{.}\PYG{n+na}{clear}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{estadosAnteriores}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{n}{estadoInicial}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Restaurar el estado inicial}
\PYG{+w}{        }\PYG{n}{pilaSimulacion}\PYG{p}{.}\PYG{n+na}{clear}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{pilaSimulacion}\PYG{p}{.}\PYG{n+na}{addAll}\PYG{p}{(}\PYG{n}{estadoInicial}\PYG{p}{.}\PYG{n+na}{pila}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{n}{entradaSimulacion}\PYG{p}{.}\PYG{n+na}{clear}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{entradaSimulacion}\PYG{p}{.}\PYG{n+na}{addAll}\PYG{p}{(}\PYG{n}{estadoInicial}\PYG{p}{.}\PYG{n+na}{entrada}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Actualizar la vista (solo la tabla de historial)}
\PYG{+w}{        }\PYG{n}{actualizarVista}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Limpiar el historial}
\PYG{+w}{        }\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{clear}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{pasoActual}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Marcar que ya no se ha realizado ningún paso}
\PYG{+w}{        }\PYG{n}{seHaRealizadoAlMenosUnPaso}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{false}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Al retroceder al inicio, ya no estamos en un estado final}
\PYG{+w}{        }\PYG{n}{estadoFinalAlcanzado}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{false}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Reactivar completamente la simulación}
\PYG{+w}{        }\PYG{n}{simulacionEnCurso}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{true}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Rehabilitar TODOS los botones de navegación de avance}
\PYG{+w}{        }\PYG{n}{btnPaso}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{false}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnFinal}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{false}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Actualizar estado de botones de navegación y de informe}
\PYG{+w}{        }\PYG{n}{actualizarEstadoBotonesNavegacion}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{actualizarEstadoBotonInforme}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{actualizarPestañasHijas}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{retrocederPaso}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{o}{!}\PYG{n}{seHaRealizadoAlMenosUnPaso}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }\PYG{n}{estadosAnteriores}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{c+c1}{// No hay pasos anteriores para retroceder}
\PYG{+w}{            }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}

\PYG{+w}{        }\PYG{c+c1}{// Eliminar el estado actual}
\PYG{+w}{        }\PYG{n}{estadosAnteriores}\PYG{p}{.}\PYG{n+na}{remove}\PYG{p}{(}\PYG{n}{estadosAnteriores}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Obtener el estado anterior}
\PYG{+w}{        }\PYG{n}{EstadoSimulacion}\PYG{+w}{ }\PYG{n}{estadoAnterior}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{estadosAnteriores}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{n}{estadosAnteriores}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Restaurar el estado}
\PYG{+w}{        }\PYG{n}{pilaSimulacion}\PYG{p}{.}\PYG{n+na}{clear}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{pilaSimulacion}\PYG{p}{.}\PYG{n+na}{addAll}\PYG{p}{(}\PYG{n}{estadoAnterior}\PYG{p}{.}\PYG{n+na}{pila}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{n}{entradaSimulacion}\PYG{p}{.}\PYG{n+na}{clear}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{entradaSimulacion}\PYG{p}{.}\PYG{n+na}{addAll}\PYG{p}{(}\PYG{n}{estadoAnterior}\PYG{p}{.}\PYG{n+na}{entrada}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Actualizar la vista (solo la tabla de historial)}
\PYG{+w}{        }\PYG{n}{actualizarVista}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Actualizar el historial}
\PYG{+w}{        }\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{remove}\PYG{p}{(}\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{pasoActual}\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZhy{}}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Al retroceder, ya no estamos en un estado final}
\PYG{+w}{        }\PYG{n}{estadoFinalAlcanzado}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{false}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Reactivar la simulación ya que estamos retrocediendo}
\PYG{+w}{        }\PYG{n}{simulacionEnCurso}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{true}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Rehabilitar los botones de navegación AVANCE (paso y final)}
\PYG{+w}{        }\PYG{n}{btnPaso}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{false}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{btnFinal}\PYG{p}{.}\PYG{n+na}{setDisable}\PYG{p}{(}\PYG{k+kc}{false}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Si después de retroceder solo queda el estado inicial, marcar que no se ha realizado ningún paso}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{estadosAnteriores}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{seHaRealizadoAlMenosUnPaso}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{false}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}

\PYG{+w}{        }\PYG{c+c1}{// Actualizar estado de botones de navegación y de informe}
\PYG{+w}{        }\PYG{n}{actualizarEstadoBotonesNavegacion}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{actualizarEstadoBotonInforme}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{actualizarPestañasHijas}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{actualizarVista}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{c+c1}{// Ya no necesitamos actualizar áreas de texto individuales}
\PYG{+w}{        }\PYG{c+c1}{// Solo la tabla de historial se actualiza automáticamente}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Centra el diálogo respecto a la ventana padre}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{centrarDialogoEnVentanaPadre}\PYG{p}{(}\PYG{n}{Stage}\PYG{+w}{ }\PYG{n}{dialog}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{Stage}\PYG{+w}{ }\PYG{n}{parentStage}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{dialog}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{parentStage}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{c+c1}{// Obtener las dimensiones de la pantalla}
\PYG{+w}{            }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{stage}\PYG{p}{.}\PYG{n+na}{Screen}\PYG{+w}{ }\PYG{n}{screen}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{stage}\PYG{p}{.}\PYG{n+na}{Screen}\PYG{p}{.}\PYG{n+na}{getPrimary}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{geometry}\PYG{p}{.}\PYG{n+na}{Rectangle2D}\PYG{+w}{ }\PYG{n}{screenBounds}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{screen}\PYG{p}{.}\PYG{n+na}{getVisualBounds}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Calcular la posición centrada}
\PYG{+w}{            }\PYG{k+kt}{double}\PYG{+w}{ }\PYG{n}{centerX}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{parentStage}\PYG{p}{.}\PYG{n+na}{getX}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{parentStage}\PYG{p}{.}\PYG{n+na}{getWidth}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{dialog}\PYG{p}{.}\PYG{n+na}{getWidth}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k+kt}{double}\PYG{+w}{ }\PYG{n}{centerY}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{parentStage}\PYG{p}{.}\PYG{n+na}{getY}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{parentStage}\PYG{p}{.}\PYG{n+na}{getHeight}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{dialog}\PYG{p}{.}\PYG{n+na}{getHeight}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{/}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Asegurar que el diálogo no se salga de la pantalla}
\PYG{+w}{            }\PYG{n}{centerX}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{Math}\PYG{p}{.}\PYG{n+na}{max}\PYG{p}{(}\PYG{n}{screenBounds}\PYG{p}{.}\PYG{n+na}{getMinX}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{Math}\PYG{p}{.}\PYG{n+na}{min}\PYG{p}{(}\PYG{n}{centerX}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{screenBounds}\PYG{p}{.}\PYG{n+na}{getMaxX}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{n}{dialog}\PYG{p}{.}\PYG{n+na}{getWidth}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{centerY}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{Math}\PYG{p}{.}\PYG{n+na}{max}\PYG{p}{(}\PYG{n}{screenBounds}\PYG{p}{.}\PYG{n+na}{getMinY}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{Math}\PYG{p}{.}\PYG{n+na}{min}\PYG{p}{(}\PYG{n}{centerY}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{screenBounds}\PYG{p}{.}\PYG{n+na}{getMaxY}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{n}{dialog}\PYG{p}{.}\PYG{n+na}{getHeight}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Aplicar la posición}
\PYG{+w}{            }\PYG{n}{dialog}\PYG{p}{.}\PYG{n+na}{setX}\PYG{p}{(}\PYG{n}{centerX}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{dialog}\PYG{p}{.}\PYG{n+na}{setY}\PYG{p}{(}\PYG{n}{centerY}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{boolean}\PYG{+w}{ }\PYG{n+nf}{esTerminal}\PYG{p}{(}\PYG{n}{String}\PYG{+w}{ }\PYG{n}{simbolo}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{gramatica}\PYG{p}{.}\PYG{n+na}{getTerminales}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{stream}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{anyMatch}\PYG{p}{(}\PYG{n}{t}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{t}\PYG{p}{.}\PYG{n+na}{getNombre}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{n}{simbolo}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n+nf}{buscarAccionTabla}\PYG{p}{(}\PYG{n}{String}\PYG{+w}{ }\PYG{n}{noTerminal}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{terminal}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{c+c1}{// Buscar la acción en la tabla predictiva extendida}
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kd}{var}\PYG{+w}{ }\PYG{n}{fila}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{tablaPredictiva}\PYG{p}{.}\PYG{n+na}{getTablaPredictiva}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getItems}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{fila}\PYG{p}{.}\PYG{n+na}{getSimbolo}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{n}{noTerminal}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{fila}\PYG{p}{.}\PYG{n+na}{getValor}\PYG{p}{(}\PYG{n}{terminal}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{return}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{agregarPasoHistorial}\PYG{p}{(}\PYG{n}{String}\PYG{+w}{ }\PYG{n}{accion}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{pilaStr}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{String}\PYG{p}{.}\PYG{n+na}{join}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{ }\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pilaSimulacion}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{entradaStr}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{String}\PYG{p}{.}\PYG{n+na}{join}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{ }\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{entradaSimulacion}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{k}{new}\PYG{+w}{ }\PYG{n}{HistorialPaso}\PYG{p}{(}\PYG{n}{String}\PYG{p}{.}\PYG{n+na}{valueOf}\PYG{p}{(}\PYG{n}{pasoActual}\PYG{p}{)}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pilaStr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{entradaStr}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{accion}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Crea una pestaña de derivación usando TabManager para gestión correcta de grupos.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Tab}\PYG{+w}{ }\PYG{n+nf}{crearPestanaDerivacionConTabManager}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{simulacionId}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{System}\PYG{p}{.}\PYG{n+na}{err}\PYG{p}{.}\PYG{n+na}{println}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Error: simulacionId es null en crearPestanaDerivacionConTabManager}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{return}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{childId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{derivacion\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{simulacionId}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{tituloBase}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.tab.derivacion}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Crear contenedor principal con estilo moderno}
\PYG{+w}{        }\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{VBox}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{setAlignment}\PYG{p}{(}\PYG{n}{Pos}\PYG{p}{.}\PYG{n+na}{TOP\PYGZus{}CENTER}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{setPadding}\PYG{p}{(}\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Insets}\PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{40}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{20}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{40}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{addAll}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{wizard\PYGZhy{}step}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{derivacion\PYGZhy{}tab}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Header del título}
\PYG{+w}{        }\PYG{n}{Label}\PYG{+w}{ }\PYG{n}{headerLabel}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Label}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.derivacion.titulo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{headerLabel}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{wizard\PYGZhy{}header}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{headerLabel}\PYG{p}{.}\PYG{n+na}{setAlignment}\PYG{p}{(}\PYG{n}{Pos}\PYG{p}{.}\PYG{n+na}{CENTER}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Contenedor del contenido}
\PYG{+w}{        }\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{VBox}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{wizard\PYGZhy{}content}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{setAlignment}\PYG{p}{(}\PYG{n}{Pos}\PYG{p}{.}\PYG{n+na}{TOP\PYGZus{}CENTER}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{VBox}\PYG{p}{.}\PYG{n+na}{setVgrow}\PYG{p}{(}\PYG{n}{contentContainer}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{Priority}\PYG{p}{.}\PYG{n+na}{ALWAYS}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Label descriptivo}
\PYG{+w}{        }\PYG{n}{Label}\PYG{+w}{ }\PYG{n}{descriptionLabel}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Label}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.derivacion.descripcion}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{descriptionLabel}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{wizard\PYGZhy{}section\PYGZhy{}header}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{descriptionLabel}\PYG{p}{.}\PYG{n+na}{setAlignment}\PYG{p}{(}\PYG{n}{Pos}\PYG{p}{.}\PYG{n+na}{CENTER}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Lista de derivación con estilo moderno}
\PYG{+w}{        }\PYG{n}{ListView}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{listaDerivacion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{ListView}\PYG{o}{\PYGZlt{}}\PYG{o}{\PYGZgt{}}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{listaDerivacion}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{derivacion\PYGZhy{}list}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{listaDerivacion}\PYG{p}{.}\PYG{n+na}{setEditable}\PYG{p}{(}\PYG{k+kc}{false}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{VBox}\PYG{p}{.}\PYG{n+na}{setVgrow}\PYG{p}{(}\PYG{n}{listaDerivacion}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{Priority}\PYG{p}{.}\PYG{n+na}{ALWAYS}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Generar la derivación como lista}
\PYG{+w}{        }\PYG{n}{ObservableList}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{itemsDerivacion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{FXCollections}\PYG{p}{.}\PYG{n+na}{observableArrayList}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{isEmpty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{itemsDerivacion}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.derivacion.iniciar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{o}{+}\PYG{o}{+}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{HistorialPaso}\PYG{+w}{ }\PYG{n}{paso}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{itemsDerivacion}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.derivacion.paso}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{ }\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{i}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{: }\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{paso}\PYG{p}{.}\PYG{n+na}{getAccion}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{n}{listaDerivacion}\PYG{p}{.}\PYG{n+na}{setItems}\PYG{p}{(}\PYG{n}{itemsDerivacion}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Agregar elementos al contenedor de contenido}
\PYG{+w}{        }\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{addAll}\PYG{p}{(}\PYG{n}{descriptionLabel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{listaDerivacion}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Agregar elementos al contenedor principal}
\PYG{+w}{        }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{addAll}\PYG{p}{(}\PYG{n}{headerLabel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Usar TabManager para crear la pestaña como hija de la simulación}
\PYG{+w}{        }\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{nuevaPestana}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{getOrCreateTab}\PYG{p}{(}
\PYG{+w}{            }\PYG{n}{tabPane}\PYG{p}{,}
\PYG{+w}{            }\PYG{n}{VBox}\PYG{p}{.}\PYG{n+na}{class}\PYG{p}{,}\PYG{+w}{ }\PYG{c+c1}{// Usar VBox como tipo de contenido}
\PYG{+w}{            }\PYG{n}{tituloBase}\PYG{p}{,}
\PYG{+w}{            }\PYG{n}{mainContainer}\PYG{p}{,}
\PYG{+w}{            }\PYG{n}{simulacionId}\PYG{p}{,}\PYG{+w}{ }\PYG{c+c1}{// parentId es el ID de la simulación}
\PYG{+w}{            }\PYG{n}{childId}
\PYG{+w}{        }\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{nuevaPestana}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Crea una pestaña de árbol sintáctico usando TabManager para gestión correcta de grupos.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Tab}\PYG{+w}{ }\PYG{n+nf}{crearPestanaArbolConTabManager}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{simulacionId}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{System}\PYG{p}{.}\PYG{n+na}{err}\PYG{p}{.}\PYG{n+na}{println}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Error: simulacionId es null en crearPestanaArbolConTabManager}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{return}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{childId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{arbol\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{simulacionId}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{tituloBase}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.tab.arbol}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Crear contenedor principal con estilo moderno}
\PYG{+w}{        }\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{VBox}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{setAlignment}\PYG{p}{(}\PYG{n}{Pos}\PYG{p}{.}\PYG{n+na}{TOP\PYGZus{}CENTER}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{setPadding}\PYG{p}{(}\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Insets}\PYG{p}{(}\PYG{l+m+mi}{20}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{40}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{20}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{40}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{addAll}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{wizard\PYGZhy{}step}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{arbol\PYGZhy{}tab}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Header del título}
\PYG{+w}{        }\PYG{n}{Label}\PYG{+w}{ }\PYG{n}{headerLabel}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Label}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.arbol.titulo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{headerLabel}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{wizard\PYGZhy{}header}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{headerLabel}\PYG{p}{.}\PYG{n+na}{setAlignment}\PYG{p}{(}\PYG{n}{Pos}\PYG{p}{.}\PYG{n+na}{CENTER}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Contenedor del contenido}
\PYG{+w}{        }\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{VBox}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{wizard\PYGZhy{}content}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{setAlignment}\PYG{p}{(}\PYG{n}{Pos}\PYG{p}{.}\PYG{n+na}{TOP\PYGZus{}CENTER}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{VBox}\PYG{p}{.}\PYG{n+na}{setVgrow}\PYG{p}{(}\PYG{n}{contentContainer}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{Priority}\PYG{p}{.}\PYG{n+na}{ALWAYS}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Label descriptivo}
\PYG{+w}{        }\PYG{n}{Label}\PYG{+w}{ }\PYG{n}{descriptionLabel}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Label}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.arbol.descripcion}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{descriptionLabel}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{wizard\PYGZhy{}section\PYGZhy{}header}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{descriptionLabel}\PYG{p}{.}\PYG{n+na}{setAlignment}\PYG{p}{(}\PYG{n}{Pos}\PYG{p}{.}\PYG{n+na}{CENTER}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Crear el árbol con al menos el nodo inicial}
\PYG{+w}{        }\PYG{n}{NodoArbol}\PYG{+w}{ }\PYG{n}{raiz}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{isEmpty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{raiz}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{NodoArbol}\PYG{p}{(}\PYG{n}{gramatica}\PYG{p}{.}\PYG{n+na}{getSimbInicial}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{raiz}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{construirArbolDesdeHistorial}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Generar el código DOT para Graphviz}
\PYG{+w}{        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{dotCode}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{generarDotDesdeArbol}\PYG{p}{(}\PYG{n}{raiz}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{k}{try}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{c+c1}{// Crear un archivo temporal para el código DOT}
\PYG{+w}{            }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Path}\PYG{+w}{ }\PYG{n}{dotFile}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Files}\PYG{p}{.}\PYG{n+na}{createTempFile}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{arbol\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{.dot}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Files}\PYG{p}{.}\PYG{n+na}{write}\PYG{p}{(}\PYG{n}{dotFile}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{dotCode}\PYG{p}{.}\PYG{n+na}{getBytes}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Crear un archivo temporal para la imagen}
\PYG{+w}{            }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Path}\PYG{+w}{ }\PYG{n}{imgFile}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Files}\PYG{p}{.}\PYG{n+na}{createTempFile}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{arbol\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{.png}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Ejecutar Graphviz para generar la imagen}
\PYG{+w}{            }\PYG{n}{ProcessBuilder}\PYG{+w}{ }\PYG{n}{pb}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{ProcessBuilder}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{dot}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZhy{}Tpng}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{dotFile}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZhy{}o}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{imgFile}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{Process}\PYG{+w}{ }\PYG{n}{process}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{pb}\PYG{p}{.}\PYG{n+na}{start}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{process}\PYG{p}{.}\PYG{n+na}{waitFor}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Cargar la imagen en un ImageView}
\PYG{+w}{            }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{image}\PYG{p}{.}\PYG{n+na}{Image}\PYG{+w}{ }\PYG{n}{imagen}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{image}\PYG{p}{.}\PYG{n+na}{Image}\PYG{p}{(}\PYG{n}{imgFile}\PYG{p}{.}\PYG{n+na}{toUri}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{image}\PYG{p}{.}\PYG{n+na}{ImageView}\PYG{+w}{ }\PYG{n}{imageView}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{image}\PYG{p}{.}\PYG{n+na}{ImageView}\PYG{p}{(}\PYG{n}{imagen}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{imageView}\PYG{p}{.}\PYG{n+na}{setPreserveRatio}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{imageView}\PYG{p}{.}\PYG{n+na}{setFitWidth}\PYG{p}{(}\PYG{l+m+mi}{800}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Crear un ScrollPane para permitir zoom y scroll}
\PYG{+w}{            }\PYG{n}{ScrollPane}\PYG{+w}{ }\PYG{n}{scrollPane}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{ScrollPane}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{scrollPane}\PYG{p}{.}\PYG{n+na}{setContent}\PYG{p}{(}\PYG{n}{imageView}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{scrollPane}\PYG{p}{.}\PYG{n+na}{setFitToWidth}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{scrollPane}\PYG{p}{.}\PYG{n+na}{setFitToHeight}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{scrollPane}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{arbol\PYGZhy{}scroll\PYGZhy{}pane}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{VBox}\PYG{p}{.}\PYG{n+na}{setVgrow}\PYG{p}{(}\PYG{n}{scrollPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{Priority}\PYG{p}{.}\PYG{n+na}{ALWAYS}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Contenedor para controles de zoom}
\PYG{+w}{            }\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{controlsContainer}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{VBox}\PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{controlsContainer}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{arbol\PYGZhy{}controls}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{controlsContainer}\PYG{p}{.}\PYG{n+na}{setAlignment}\PYG{p}{(}\PYG{n}{Pos}\PYG{p}{.}\PYG{n+na}{CENTER}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Label para el slider}
\PYG{+w}{            }\PYG{n}{Label}\PYG{+w}{ }\PYG{n}{zoomLabel}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Label}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.arbol.zoom}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{zoomLabel}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{wizard\PYGZhy{}field\PYGZhy{}label}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{zoomLabel}\PYG{p}{.}\PYG{n+na}{setAlignment}\PYG{p}{(}\PYG{n}{Pos}\PYG{p}{.}\PYG{n+na}{CENTER}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Añadir controles de zoom}
\PYG{+w}{            }\PYG{n}{Slider}\PYG{+w}{ }\PYG{n}{zoomSlider}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Slider}\PYG{p}{(}\PYG{l+m+mf}{0.5}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{zoomSlider}\PYG{p}{.}\PYG{n+na}{setShowTickLabels}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{zoomSlider}\PYG{p}{.}\PYG{n+na}{setShowTickMarks}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{zoomSlider}\PYG{p}{.}\PYG{n+na}{getStyleClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{arbol\PYGZhy{}zoom\PYGZhy{}slider}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Vincular el zoom del slider con la escala de la imagen}
\PYG{+w}{            }\PYG{n}{zoomSlider}\PYG{p}{.}\PYG{n+na}{valueProperty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{addListener}\PYG{p}{(}\PYG{p}{(}\PYG{n}{obs}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{oldVal}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{newVal}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{imageView}\PYG{p}{.}\PYG{n+na}{setScaleX}\PYG{p}{(}\PYG{n}{newVal}\PYG{p}{.}\PYG{n+na}{doubleValue}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{imageView}\PYG{p}{.}\PYG{n+na}{setScaleY}\PYG{p}{(}\PYG{n}{newVal}\PYG{p}{.}\PYG{n+na}{doubleValue}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Agregar controles al contenedor}
\PYG{+w}{            }\PYG{n}{controlsContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{addAll}\PYG{p}{(}\PYG{n}{zoomLabel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{zoomSlider}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Agregar elementos al contenedor de contenido}
\PYG{+w}{            }\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{addAll}\PYG{p}{(}\PYG{n}{descriptionLabel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{scrollPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{controlsContainer}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Agregar elementos al contenedor principal}
\PYG{+w}{            }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{addAll}\PYG{p}{(}\PYG{n}{headerLabel}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Usar TabManager para crear la pestaña como hija de la simulación}
\PYG{+w}{            }\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{nuevaPestana}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{getOrCreateTab}\PYG{p}{(}
\PYG{+w}{                }\PYG{n}{tabPane}\PYG{p}{,}
\PYG{+w}{                }\PYG{n}{VBox}\PYG{p}{.}\PYG{n+na}{class}\PYG{p}{,}\PYG{+w}{ }\PYG{c+c1}{// Usar VBox como tipo de contenido}
\PYG{+w}{                }\PYG{n}{tituloBase}\PYG{p}{,}
\PYG{+w}{                }\PYG{n}{mainContainer}\PYG{p}{,}
\PYG{+w}{                }\PYG{n}{simulacionId}\PYG{p}{,}\PYG{+w}{ }\PYG{c+c1}{// parentId es el ID de la simulación}
\PYG{+w}{                }\PYG{n}{childId}
\PYG{+w}{            }\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Limpiar archivos temporales}
\PYG{+w}{            }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Files}\PYG{p}{.}\PYG{n+na}{deleteIfExists}\PYG{p}{(}\PYG{n}{dotFile}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Files}\PYG{p}{.}\PYG{n+na}{deleteIfExists}\PYG{p}{(}\PYG{n}{imgFile}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{nuevaPestana}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{catch}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Exception}\PYG{+w}{ }\PYG{n}{e}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{e}\PYG{p}{.}\PYG{n+na}{printStackTrace}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{return}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Muestra la derivación de la simulación actual.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{mostrarDerivacion}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{simulacionId}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{System}\PYG{p}{.}\PYG{n+na}{err}\PYG{p}{.}\PYG{n+na}{println}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Error: simulacionId es null en mostrarDerivacion}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Buscar si ya existe una pestaña de derivación para esta simulación}
\PYG{+w}{        }\PYG{n}{derivacionTab}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{tab}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{userData}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{userData}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{derivacion\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{simulacionId}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{derivacionTab}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{;}
\PYG{+w}{                    }\PYG{k}{break}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Si no existe la pestaña, crearla usando TabManager}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{derivacionTab}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{derivacionTab}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{crearPestanaDerivacionConTabManager}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Añadir listener para cuando se cierre la pestaña}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{derivacionTab}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{derivacionTab}\PYG{p}{.}\PYG{n+na}{setOnClosed}\PYG{p}{(}\PYG{n}{e}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{derivacionTab}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{c+c1}{// Si ya existe, actualizar su contenido}
\PYG{+w}{            }\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{VBox}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{derivacionTab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{VBox}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// El segundo elemento es el contentContainer}
\PYG{+w}{            }\PYG{n}{ListView}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{listaDerivacion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{ListView}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n+nd}{@SuppressWarnings}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{unchecked}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}
\PYG{+w}{                }\PYG{n}{ListView}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{tempList}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{ListView}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{listaDerivacion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tempList}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}

\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{listaDerivacion}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{c+c1}{// Generar la derivación como lista}
\PYG{+w}{                }\PYG{n}{ObservableList}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{itemsDerivacion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{FXCollections}\PYG{p}{.}\PYG{n+na}{observableArrayList}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{isEmpty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                            }\PYG{n}{itemsDerivacion}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.derivacion.iniciar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                                }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{o}{+}\PYG{o}{+}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                }\PYG{n}{HistorialPaso}\PYG{+w}{ }\PYG{n}{paso}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                }\PYG{n}{itemsDerivacion}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.derivacion.paso}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{ }\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{i}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{: }\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{paso}\PYG{p}{.}\PYG{n+na}{getAccion}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                }\PYG{n}{listaDerivacion}\PYG{p}{.}\PYG{n+na}{setItems}\PYG{p}{(}\PYG{n}{itemsDerivacion}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Seleccionar la pestaña}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{derivacionTab}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getSelectionModel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{select}\PYG{p}{(}\PYG{n}{derivacionTab}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Muestra el árbol sintáctico de la simulación actual.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{mostrarArbolSintactico}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{simulacionId}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{System}\PYG{p}{.}\PYG{n+na}{err}\PYG{p}{.}\PYG{n+na}{println}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Error: simulacionId es null en mostrarArbolSintactico}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{n}{arbolTab}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{tab}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{userData}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{userData}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{arbol\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{simulacionId}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{arbolTab}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{;}
\PYG{+w}{                    }\PYG{k}{break}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Si no existe la pestaña, crearla usando TabManager}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{arbolTab}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{arbolTab}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{crearPestanaArbolConTabManager}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Añadir listener para cuando se cierre la pestaña}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{arbolTab}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{arbolTab}\PYG{p}{.}\PYG{n+na}{setOnClosed}\PYG{p}{(}\PYG{n}{e}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{arbolTab}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{c+c1}{// Si ya existe, actualizar su contenido}
\PYG{+w}{            }\PYG{n}{actualizarContenidoArbol}\PYG{p}{(}\PYG{n}{arbolTab}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Seleccionar la pestaña}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{arbolTab}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getSelectionModel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{select}\PYG{p}{(}\PYG{n}{arbolTab}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Actualiza el contenido de una pestaña de árbol existente.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{actualizarContenidoArbol}\PYG{p}{(}\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{arbolTab}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{c+c1}{// Construir el nuevo árbol}
\PYG{+w}{        }\PYG{n}{NodoArbol}\PYG{+w}{ }\PYG{n}{raiz}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{isEmpty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{raiz}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{NodoArbol}\PYG{p}{(}\PYG{n}{gramatica}\PYG{p}{.}\PYG{n+na}{getSimbInicial}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{raiz}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{construirArbolDesdeHistorial}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}

\PYG{+w}{        }\PYG{c+c1}{// Generar el código DOT para Graphviz}
\PYG{+w}{        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{dotCode}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{generarDotDesdeArbol}\PYG{p}{(}\PYG{n}{raiz}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{k}{try}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{c+c1}{// Crear un archivo temporal para el código DOT}
\PYG{+w}{            }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Path}\PYG{+w}{ }\PYG{n}{dotFile}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Files}\PYG{p}{.}\PYG{n+na}{createTempFile}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{arbol\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{.dot}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Files}\PYG{p}{.}\PYG{n+na}{write}\PYG{p}{(}\PYG{n}{dotFile}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{dotCode}\PYG{p}{.}\PYG{n+na}{getBytes}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Crear un archivo temporal para la imagen}
\PYG{+w}{            }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Path}\PYG{+w}{ }\PYG{n}{imgFile}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Files}\PYG{p}{.}\PYG{n+na}{createTempFile}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{arbol\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{.png}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Ejecutar Graphviz para generar la imagen}
\PYG{+w}{            }\PYG{n}{ProcessBuilder}\PYG{+w}{ }\PYG{n}{pb}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{ProcessBuilder}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{dot}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZhy{}Tpng}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{dotFile}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZhy{}o}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{imgFile}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{Process}\PYG{+w}{ }\PYG{n}{process}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{pb}\PYG{p}{.}\PYG{n+na}{start}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{process}\PYG{p}{.}\PYG{n+na}{waitFor}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Cargar la imagen en un ImageView}
\PYG{+w}{            }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{image}\PYG{p}{.}\PYG{n+na}{Image}\PYG{+w}{ }\PYG{n}{imagen}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{image}\PYG{p}{.}\PYG{n+na}{Image}\PYG{p}{(}\PYG{n}{imgFile}\PYG{p}{.}\PYG{n+na}{toUri}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{image}\PYG{p}{.}\PYG{n+na}{ImageView}\PYG{+w}{ }\PYG{n}{imageView}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{image}\PYG{p}{.}\PYG{n+na}{ImageView}\PYG{p}{(}\PYG{n}{imagen}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{imageView}\PYG{p}{.}\PYG{n+na}{setPreserveRatio}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{imageView}\PYG{p}{.}\PYG{n+na}{setFitWidth}\PYG{p}{(}\PYG{l+m+mi}{800}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Obtener el contenedor VBox existente y navegar a través de la jerarquía}
\PYG{+w}{            }\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{VBox}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{arbolTab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{            }\PYG{c+c1}{// La estructura es: mainContainer \PYGZhy{}\PYGZgt{} [headerLabel, contentContainer]}
\PYG{+w}{            }\PYG{c+c1}{// contentContainer \PYGZhy{}\PYGZgt{} [descriptionLabel, scrollPane, controlsContainer]}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{VBox}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// contentContainer}

\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{ScrollPane}\PYG{+w}{ }\PYG{n}{scrollPane}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{ScrollPane}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// scrollPane}

\PYG{+w}{                    }\PYG{c+c1}{// Actualizar el contenido del ScrollPane}
\PYG{+w}{                    }\PYG{n}{scrollPane}\PYG{p}{.}\PYG{n+na}{setContent}\PYG{p}{(}\PYG{n}{imageView}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{                    }\PYG{c+c1}{// Limpiar archivos temporales}
\PYG{+w}{                    }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Files}\PYG{p}{.}\PYG{n+na}{deleteIfExists}\PYG{p}{(}\PYG{n}{dotFile}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{n}{java}\PYG{p}{.}\PYG{n+na}{nio}\PYG{p}{.}\PYG{n+na}{file}\PYG{p}{.}\PYG{n+na}{Files}\PYG{p}{.}\PYG{n+na}{deleteIfExists}\PYG{p}{(}\PYG{n}{imgFile}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{System}\PYG{p}{.}\PYG{n+na}{err}\PYG{p}{.}\PYG{n+na}{println}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Error: No se encontró el ScrollPane en la estructura esperada}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{System}\PYG{p}{.}\PYG{n+na}{err}\PYG{p}{.}\PYG{n+na}{println}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Error: Estructura del contenedor no es la esperada}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{catch}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Exception}\PYG{+w}{ }\PYG{n}{e}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{e}\PYG{p}{.}\PYG{n+na}{printStackTrace}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n+nf}{generarDotDesdeArbol}\PYG{p}{(}\PYG{n}{NodoArbol}\PYG{+w}{ }\PYG{n}{raiz}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{StringBuilder}\PYG{+w}{ }\PYG{n}{sb}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{StringBuilder}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{sb}\PYG{p}{.}\PYG{n+na}{append}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{digraph G \PYGZob{}}\PYG{l+s}{\PYGZbs{}}\PYG{l+s}{n}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{sb}\PYG{p}{.}\PYG{n+na}{append}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{  node [shape=box, style=rounded, fontname=}\PYG{l+s}{\PYGZbs{}\PYGZdq{}}\PYG{l+s}{Arial}\PYG{l+s}{\PYGZbs{}\PYGZdq{}}\PYG{l+s}{];}\PYG{l+s}{\PYGZbs{}}\PYG{l+s}{n}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{sb}\PYG{p}{.}\PYG{n+na}{append}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{  edge [arrowhead=none];}\PYG{l+s}{\PYGZbs{}}\PYG{l+s}{n}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Usar un contador para generar IDs únicos de nodos}
\PYG{+w}{        }\PYG{k+kt}{int}\PYG{o}{[}\PYG{o}{]}\PYG{+w}{ }\PYG{n}{idCounter}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{l+m+mi}{0}\PYG{p}{\PYGZcb{}}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{generarDotRec}\PYG{p}{(}\PYG{n}{raiz}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{sb}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{idCounter}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{n}{sb}\PYG{p}{.}\PYG{n+na}{append}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZcb{}}\PYG{l+s}{\PYGZbs{}}\PYG{l+s}{n}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{sb}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{generarDotRec}\PYG{p}{(}\PYG{n}{NodoArbol}\PYG{+w}{ }\PYG{n}{nodo}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{StringBuilder}\PYG{+w}{ }\PYG{n}{sb}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{o}{[}\PYG{o}{]}\PYG{+w}{ }\PYG{n}{id}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{parentId}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{myId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{n}\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{id}\PYG{o}{[}\PYG{l+m+mi}{0}\PYG{o}{]}\PYG{o}{+}\PYG{o}{+}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{sb}\PYG{p}{.}\PYG{n+na}{append}\PYG{p}{(}\PYG{n}{myId}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{ [label=}\PYG{l+s}{\PYGZbs{}\PYGZdq{}}\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{nodo}\PYG{p}{.}\PYG{n+na}{valor}\PYG{p}{.}\PYG{n+na}{replace}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZbs{}\PYGZdq{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZbs{}\PYGZbs{}}\PYG{l+s}{\PYGZbs{}\PYGZdq{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZbs{}\PYGZdq{}}\PYG{l+s}{];}\PYG{l+s}{\PYGZbs{}}\PYG{l+s}{n}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{parentId}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{sb}\PYG{p}{.}\PYG{n+na}{append}\PYG{p}{(}\PYG{n}{parentId}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{ \PYGZhy{}\PYGZgt{} }\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{myId}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{;}\PYG{l+s}{\PYGZbs{}}\PYG{l+s}{n}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{NodoArbol}\PYG{+w}{ }\PYG{n}{hijo}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{nodo}\PYG{p}{.}\PYG{n+na}{hijos}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{generarDotRec}\PYG{p}{(}\PYG{n}{hijo}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{sb}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{id}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{myId}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+c1}{// Modelo para la tabla de historial}
\PYG{+w}{    }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{k+kd}{static}\PYG{+w}{ }\PYG{k+kd}{class} \PYG{n+nc}{HistorialPaso}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kd}{final}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{paso}\PYG{p}{;}
\PYG{+w}{        }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kd}{final}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{pila}\PYG{p}{;}
\PYG{+w}{        }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kd}{final}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{entrada}\PYG{p}{;}
\PYG{+w}{        }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kd}{final}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{accion}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{n+nf}{HistorialPaso}\PYG{p}{(}\PYG{n}{String}\PYG{+w}{ }\PYG{n}{paso}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{pila}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{entrada}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{accion}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{paso}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{paso}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{pila}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{pila}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{entrada}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{entrada}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{accion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{accion}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n+nf}{getPaso}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{+w}{ }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{paso}\PYG{p}{;}\PYG{+w}{ }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n+nf}{getPila}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{+w}{ }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{pila}\PYG{p}{;}\PYG{+w}{ }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n+nf}{getEntrada}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{+w}{ }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{entrada}\PYG{p}{;}\PYG{+w}{ }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n+nf}{getAccion}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{+w}{ }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{accion}\PYG{p}{;}\PYG{+w}{ }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{n+nd}{@Override}
\PYG{+w}{    }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{actualizarTextos}\PYG{p}{(}\PYG{n}{ResourceBundle}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{bundle}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Actualizar textos de los controles que existen en el FXML}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{labelTitulo}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{labelTitulo}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.titulo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{labelEntrada}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{labelEntrada}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.label.entrada}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{labelHistorial}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{labelHistorial}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.label.historial}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Actualizar textos de los botones}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnIniciar}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{btnIniciar}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.btn.iniciar.solo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnPaso}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{btnPaso}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.btn.paso.solo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnFinal}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{btnFinal}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.btn.final.solo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnRetroceso}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{btnRetroceso}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.btn.retroceso.solo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnInicio}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{btnInicio}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.btn.inicio.solo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnEditarCadena}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{btnEditarCadena}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.btn.editar.solo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnDerivacion}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{btnDerivacion}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.btn.derivacion.solo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnArbol}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{btnArbol}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.btn.informe.solo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnGenerarInforme}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{btnGenerarInforme}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.btn.informe.pdf}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Actualizar encabezados de las columnas de la tabla}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{colPaso}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{colPaso}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.col.paso}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{colPila}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{colPila}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.col.pila}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{colEntrada}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{colEntrada}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.col.entrada}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{colAccion}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{colAccion}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.col.accion}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Actualizar títulos de las pestañas}
\PYG{+w}{        }\PYG{n}{actualizarTitulosPestañas}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Actualizar contenido de las pestañas de derivación y árbol sintáctico}
\PYG{+w}{        }\PYG{n}{actualizarContenidoPestañasHijas}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Actualizar la tabla de historial principal}
\PYG{+w}{        }\PYG{n}{actualizarTablaHistorial}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Actualiza el contenido de las pestañas de derivación y árbol sintáctico.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{actualizarContenidoPestañasHijas}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tabPane}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }\PYG{n}{bundle}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{tab}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{userData}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }
\PYG{+w}{                }\PYG{c+c1}{// Actualizar pestaña de derivación}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{userData}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{derivacion\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{simulacionId}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{actualizarContenidoPestañaDerivacion}\PYG{p}{(}\PYG{n}{tab}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                }\PYG{c+c1}{// Actualizar pestaña de árbol sintáctico}
\PYG{+w}{                }\PYG{k}{else}\PYG{+w}{ }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{userData}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{arbol\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{simulacionId}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{actualizarContenidoPestañaArbol}\PYG{p}{(}\PYG{n}{tab}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Actualiza la tabla de historial principal con los textos del idioma actual.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{actualizarTablaHistorial}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tablaHistorial}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }\PYG{n}{bundle}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Guardar una copia de los datos originales}
\PYG{+w}{        }\PYG{n}{List}\PYG{o}{\PYGZlt{}}\PYG{n}{HistorialPaso}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{datosOriginales}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{ArrayList}\PYG{o}{\PYGZlt{}}\PYG{o}{\PYGZgt{}}\PYG{p}{(}\PYG{n}{historialObservable}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Limpiar la lista observable}
\PYG{+w}{        }\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{clear}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Recrear los pasos con las acciones traducidas}
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{HistorialPaso}\PYG{+w}{ }\PYG{n}{pasoOriginal}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{datosOriginales}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{HistorialPaso}\PYG{+w}{ }\PYG{n}{pasoActualizado}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{HistorialPaso}\PYG{p}{(}
\PYG{+w}{                }\PYG{n}{pasoOriginal}\PYG{p}{.}\PYG{n+na}{getPaso}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
\PYG{+w}{                }\PYG{n}{pasoOriginal}\PYG{p}{.}\PYG{n+na}{getPila}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
\PYG{+w}{                }\PYG{n}{pasoOriginal}\PYG{p}{.}\PYG{n+na}{getEntrada}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
\PYG{+w}{                }\PYG{n}{traducirAccion}\PYG{p}{(}\PYG{n}{pasoOriginal}\PYG{p}{.}\PYG{n+na}{getAccion}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{+w}{            }\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{n}{pasoActualizado}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Traduce una acción del historial al idioma actual.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n+nf}{traducirAccion}\PYG{p}{(}\PYG{n}{String}\PYG{+w}{ }\PYG{n}{accion}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{bundle}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{accion}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Traducir las acciones conocidas \PYGZhy{} verificar en todos los idiomas posibles}
\PYG{+w}{        }\PYG{n}{String}\PYG{o}{[}\PYG{o}{]}\PYG{+w}{ }\PYG{n}{accionesEspanol}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Aceptar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Emparejar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Error}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Inicio}\PYG{l+s}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{String}\PYG{o}{[}\PYG{o}{]}\PYG{+w}{ }\PYG{n}{accionesIngles}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Accept}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Match}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Error}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Start}\PYG{l+s}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{String}\PYG{o}{[}\PYG{o}{]}\PYG{+w}{ }\PYG{n}{accionesFrances}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Accepter}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Associer}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Erreur}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Début}\PYG{l+s}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{String}\PYG{o}{[}\PYG{o}{]}\PYG{+w}{ }\PYG{n}{accionesAleman}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Akzeptieren}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Abgleichen}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Fehler}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Start}\PYG{l+s}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{String}\PYG{o}{[}\PYG{o}{]}\PYG{+w}{ }\PYG{n}{accionesPortugues}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Aceitar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Emparelhar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Erro}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Início}\PYG{l+s}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{String}\PYG{o}{[}\PYG{o}{]}\PYG{+w}{ }\PYG{n}{accionesJapones}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{受理}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{一致}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{エラー}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{開始}\PYG{l+s}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{n}{String}\PYG{o}{[}\PYG{o}{]}\PYG{o}{[}\PYG{o}{]}\PYG{+w}{ }\PYG{n}{todasLasAcciones}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{accionesEspanol}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{accionesIngles}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{accionesFrances}\PYG{p}{,}\PYG{+w}{ }
\PYG{+w}{            }\PYG{n}{accionesAleman}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{accionesPortugues}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{accionesJapones}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Buscar la acción en todos los idiomas}
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{String}\PYG{o}{[}\PYG{o}{]}\PYG{+w}{ }\PYG{n}{acciones}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{todasLasAcciones}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{n}{acciones}\PYG{p}{.}\PYG{n+na}{length}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{o}{+}\PYG{o}{+}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{accion}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{n}{acciones}\PYG{o}{[}\PYG{n}{i}\PYG{o}{]}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{c+c1}{// Encontrar la clave correspondiente}
\PYG{+w}{                    }\PYG{k}{switch}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                        }\PYG{k}{case}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{:}\PYG{+w}{ }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.accion.aceptar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }\PYG{k}{case}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{+w}{ }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.accion.emparejar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }\PYG{k}{case}\PYG{+w}{ }\PYG{l+m+mi}{2}\PYG{p}{:}\PYG{+w}{ }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.accion.error}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }\PYG{k}{case}\PYG{+w}{ }\PYG{l+m+mi}{3}\PYG{p}{:}\PYG{+w}{ }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.accion.inicio}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Si no es una acción conocida, devolver la original}
\PYG{+w}{        }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{accion}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Actualiza el contenido de la pestaña de derivación.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{actualizarContenidoPestañaDerivacion}\PYG{p}{(}\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{VBox}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{VBox}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Actualizar título del header}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{Label}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{Label}\PYG{+w}{ }\PYG{n}{headerLabel}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Label}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{headerLabel}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.derivacion.titulo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Actualizar descripción}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{VBox}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{VBox}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{Label}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{Label}\PYG{+w}{ }\PYG{n}{descriptionLabel}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Label}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{n}{descriptionLabel}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.derivacion.descripcion}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                }
\PYG{+w}{                }\PYG{c+c1}{// Actualizar lista de derivación}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{ListView}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n+nd}{@SuppressWarnings}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{unchecked}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}
\PYG{+w}{                    }\PYG{n}{ListView}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{listaDerivacion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{ListView}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{n}{actualizarListaDerivacion}\PYG{p}{(}\PYG{n}{listaDerivacion}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Actualiza el contenido de la pestaña de árbol sintáctico.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{actualizarContenidoPestañaArbol}\PYG{p}{(}\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{VBox}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{VBox}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Actualizar título del header}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{Label}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{Label}\PYG{+w}{ }\PYG{n}{headerLabel}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Label}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{headerLabel}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.arbol.titulo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Actualizar descripción}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{VBox}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{VBox}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{Label}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{Label}\PYG{+w}{ }\PYG{n}{descriptionLabel}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Label}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{n}{descriptionLabel}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.arbol.descripcion}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                }
\PYG{+w}{                }\PYG{c+c1}{// Buscar y actualizar el label de zoom}
\PYG{+w}{                }\PYG{n}{actualizarLabelZoom}\PYG{p}{(}\PYG{n}{contentContainer}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Busca y actualiza el label de zoom en el contenedor del árbol.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{actualizarLabelZoom}\PYG{p}{(}\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{c+c1}{// Buscar recursivamente en todos los nodos del contenedor}
\PYG{+w}{        }\PYG{n}{buscarYActualizarLabelZoom}\PYG{p}{(}\PYG{n}{contentContainer}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Busca recursivamente el label de zoom y lo actualiza.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{buscarYActualizarLabelZoom}\PYG{p}{(}\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{Node}\PYG{+w}{ }\PYG{n}{node}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{node}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{Label}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{Label}\PYG{+w}{ }\PYG{n}{label}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Label}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{node}\PYG{p}{;}
\PYG{+w}{            }\PYG{c+c1}{// Verificar si es el label de zoom (contiene \PYGZdq{}Zoom\PYGZdq{} o \PYGZdq{}Tree Zoom\PYGZdq{} o \PYGZdq{}Zoom de l\PYGZsq{}arbre\PYGZdq{})}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{label}\PYG{p}{.}\PYG{n+na}{getText}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }
\PYG{+w}{                }\PYG{p}{(}\PYG{n}{label}\PYG{p}{.}\PYG{n+na}{getText}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{contains}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Zoom}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }
\PYG{+w}{                 }\PYG{n}{label}\PYG{p}{.}\PYG{n+na}{getText}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{contains}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Tree Zoom}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }
\PYG{+w}{                 }\PYG{n}{label}\PYG{p}{.}\PYG{n+na}{getText}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{contains}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Zoom de l\PYGZsq{}arbre}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{label}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.arbol.zoom}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{node}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{Parent}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{Parent}\PYG{+w}{ }\PYG{n}{parent}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{Parent}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{node}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{Node}\PYG{+w}{ }\PYG{n}{child}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{parent}\PYG{p}{.}\PYG{n+na}{getChildrenUnmodifiable}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{buscarYActualizarLabelZoom}\PYG{p}{(}\PYG{n}{child}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Actualiza la lista de derivación con textos internacionalizados.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{actualizarListaDerivacion}\PYG{p}{(}\PYG{n}{ListView}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{listaDerivacion}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{ObservableList}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{itemsDerivacion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{FXCollections}\PYG{p}{.}\PYG{n+na}{observableArrayList}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{isEmpty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{itemsDerivacion}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.derivacion.iniciar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{o}{+}\PYG{o}{+}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{HistorialPaso}\PYG{+w}{ }\PYG{n}{paso}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{pasoText}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.derivacion.paso}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{ }\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{i}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{: }\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{paso}\PYG{p}{.}\PYG{n+na}{getAccion}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{itemsDerivacion}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{n}{pasoText}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{n}{listaDerivacion}\PYG{p}{.}\PYG{n+na}{setItems}\PYG{p}{(}\PYG{n}{itemsDerivacion}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Verifica si esta simulación pertenece a un simulador específico.}
\PYG{c+cm}{     * @param simuladorId El ID del simulador a verificar}
\PYG{c+cm}{     * @return true si la simulación pertenece al simulador especificado}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{k+kt}{boolean}\PYG{+w}{ }\PYG{n+nf}{perteneceASimulador}\PYG{p}{(}\PYG{n}{String}\PYG{+w}{ }\PYG{n}{simuladorId}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{return}\PYG{+w}{ }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{simuladorPadreId}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{simuladorPadreId}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{n}{simuladorId}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Verifica si una pestaña es hija de esta simulación.}
\PYG{c+cm}{     * @param tab La pestaña a verificar}
\PYG{c+cm}{     * @return true si la pestaña es una derivación o árbol sintáctico de esta simulación}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{k+kt}{boolean}\PYG{+w}{ }\PYG{n+nf}{esHijaDeLaSimulacion}\PYG{p}{(}\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tab}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{+w}{ }\PYG{k+kc}{false}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{userData}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{return}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{userData}\PYG{p}{.}\PYG{n+na}{startsWith}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{derivacion\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }\PYG{n}{userData}\PYG{p}{.}\PYG{n+na}{startsWith}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{arbol\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }
\PYG{+w}{               }\PYG{n}{userData}\PYG{p}{.}\PYG{n+na}{endsWith}\PYG{p}{(}\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{simulacionId}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Obtiene el ID del simulador padre de esta simulación.}
\PYG{c+cm}{     * @return El ID del simulador padre}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n+nf}{getSimuladorPadreId}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{simuladorPadreId}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Cuenta el número de simulaciones que pertenecen al mismo grupo que esta simulación.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n+nf}{contarSimulacionesEnGrupo}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tabPane}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{simulacionesEnGrupo}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{tab}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{SimulacionFinal}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{SimulacionFinal}\PYG{+w}{ }\PYG{n}{sim}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{SimulacionFinal}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{sim}\PYG{p}{.}\PYG{n+na}{simuladorPadreId}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{sim}\PYG{p}{.}\PYG{n+na}{simuladorPadreId}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{simuladorPadreId}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{simulacionesEnGrupo}\PYG{o}{+}\PYG{o}{+}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{simulacionesEnGrupo}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{setGrupoId}\PYG{p}{(}\PYG{n}{String}\PYG{+w}{ }\PYG{n}{grupoId}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{grupoId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{grupoId}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{setNumeroGrupo}\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numeroGrupo}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{numeroGrupo}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{numeroGrupo}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n+nf}{getGrupoId}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{grupoId}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n+nf}{getNumeroGrupo}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{numeroGrupo}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{setNumeroInstancia}\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numeroInstancia}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{numeroInstancia}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{numeroInstancia}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n+nf}{getNumeroInstancia}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{numeroInstancia}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+c1}{// Construir el árbol sintáctico a partir del historial de pasos}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{NodoArbol}\PYG{+w}{ }\PYG{n+nf}{construirArbolDesdeHistorial}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{c+c1}{// Creamos la raíz con el símbolo inicial}
\PYG{+w}{        }\PYG{n}{NodoArbol}\PYG{+w}{ }\PYG{n}{raiz}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{NodoArbol}\PYG{p}{(}\PYG{n}{gramatica}\PYG{p}{.}\PYG{n+na}{getSimbInicial}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Crear una copia del historial para no modificar el original}
\PYG{+w}{        }\PYG{n}{List}\PYG{o}{\PYGZlt{}}\PYG{n}{HistorialPaso}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{historialCopia}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{ArrayList}\PYG{o}{\PYGZlt{}}\PYG{o}{\PYGZgt{}}\PYG{p}{(}\PYG{n}{historialObservable}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{construirRecursivo}\PYG{p}{(}\PYG{n}{raiz}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{historialCopia}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{raiz}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+c1}{// Recursivo: expande el primer no terminal de cada producción}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{construirRecursivo}\PYG{p}{(}\PYG{n}{NodoArbol}\PYG{+w}{ }\PYG{n}{nodo}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{List}\PYG{o}{\PYGZlt{}}\PYG{n}{HistorialPaso}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{pasos}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{pasos}\PYG{p}{.}\PYG{n+na}{isEmpty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Buscar la producción que expande este nodo}
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{n}{pasos}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{o}{+}\PYG{o}{+}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{HistorialPaso}\PYG{+w}{ }\PYG{n}{paso}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{pasos}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{accion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{paso}\PYG{p}{.}\PYG{n+na}{getAccion}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Si es una producción (contiene una flecha)}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{accion}\PYG{p}{.}\PYG{n+na}{contains}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{→}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{c+c1}{// Eliminar el número de producción si existe}
\PYG{+w}{                }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{accionLimpia}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{accion}\PYG{p}{.}\PYG{n+na}{replaceAll}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZca{}}\PYG{l+s}{\PYGZbs{}\PYGZbs{}}\PYG{l+s}{d+}\PYG{l+s}{\PYGZbs{}\PYGZbs{}}\PYG{l+s}{.}\PYG{l+s}{\PYGZbs{}\PYGZbs{}}\PYG{l+s}{s*}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{trim}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{String}\PYG{o}{[}\PYG{o}{]}\PYG{+w}{ }\PYG{n}{partes}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{accionLimpia}\PYG{p}{.}\PYG{n+na}{split}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{→}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{izquierda}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{partes}\PYG{o}{[}\PYG{l+m+mi}{0}\PYG{o}{]}\PYG{p}{.}\PYG{n+na}{trim}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{derecha}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{partes}\PYG{o}{[}\PYG{l+m+mi}{1}\PYG{o}{]}\PYG{p}{.}\PYG{n+na}{trim}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }
\PYG{+w}{                }\PYG{c+c1}{// Si esta producción corresponde al nodo actual}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{izquierda}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{n}{nodo}\PYG{p}{.}\PYG{n+na}{valor}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{c+c1}{// Dividir la parte derecha en símbolos}
\PYG{+w}{                    }\PYG{n}{String}\PYG{o}{[}\PYG{o}{]}\PYG{+w}{ }\PYG{n}{simbolos}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{derecha}\PYG{p}{.}\PYG{n+na}{split}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZbs{}\PYGZbs{}}\PYG{l+s}{s+}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }
\PYG{+w}{                    }\PYG{c+c1}{// Crear nodos hijos para cada símbolo}
\PYG{+w}{                    }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{String}\PYG{+w}{ }\PYG{n}{simbolo}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{simbolos}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{o}{!}\PYG{n}{simbolo}\PYG{p}{.}\PYG{n+na}{isEmpty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                            }\PYG{n}{NodoArbol}\PYG{+w}{ }\PYG{n}{hijo}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{NodoArbol}\PYG{p}{(}\PYG{n}{simbolo}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                            }\PYG{n}{nodo}\PYG{p}{.}\PYG{n+na}{hijos}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{n}{hijo}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                            }
\PYG{+w}{                            }\PYG{c+c1}{// Si el hijo es no terminal, procesarlo recursivamente}
\PYG{+w}{                            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{o}{!}\PYG{n}{esTerminal}\PYG{p}{(}\PYG{n}{simbolo}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                }\PYG{c+c1}{// Crear una nueva lista con los pasos restantes}
\PYG{+w}{                                }\PYG{n}{List}\PYG{o}{\PYGZlt{}}\PYG{n}{HistorialPaso}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{pasosRestantes}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{ArrayList}\PYG{o}{\PYGZlt{}}\PYG{o}{\PYGZgt{}}\PYG{p}{(}\PYG{n}{pasos}\PYG{p}{.}\PYG{n+na}{subList}\PYG{p}{(}\PYG{n}{i}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pasos}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                }\PYG{n}{construirRecursivo}\PYG{p}{(}\PYG{n}{hijo}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{pasosRestantes}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                    }
\PYG{+w}{                    }\PYG{c+c1}{// Remover esta producción para no reutilizarla}
\PYG{+w}{                    }\PYG{n}{pasos}\PYG{p}{.}\PYG{n+na}{remove}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Actualiza el contenido de las pestañas hijas activas (derivación y árbol).}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{actualizarPestañasHijas}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{simulacionId}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{return}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// No hay simulacionId, no se pueden actualizar las pestañas hijas}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Buscar las pestañas hijas usando TabManager}
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{tab}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{userData}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }
\PYG{+w}{                }\PYG{c+c1}{// Actualizar pestaña de derivación si está activa}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{userData}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{derivacion\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{simulacionId}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{VBox}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{n}{VBox}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{VBox}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{mainContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// El segundo elemento es el contentContainer}
\PYG{+w}{                    }\PYG{n}{ListView}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{listaDerivacion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{;}
\PYG{+w}{                    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{ListView}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                        }\PYG{n+nd}{@SuppressWarnings}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{unchecked}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}
\PYG{+w}{                        }\PYG{n}{ListView}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{tempList}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{ListView}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{contentContainer}\PYG{p}{.}\PYG{n+na}{getChildren}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }\PYG{n}{listaDerivacion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tempList}\PYG{p}{;}
\PYG{+w}{                    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{                    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{listaDerivacion}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                        }\PYG{c+c1}{// Generar la derivación como lista}
\PYG{+w}{                        }\PYG{n}{ObservableList}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{itemsDerivacion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{FXCollections}\PYG{p}{.}\PYG{n+na}{observableArrayList}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{isEmpty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                            }\PYG{n}{itemsDerivacion}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.derivacion.iniciar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                            }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{o}{+}\PYG{o}{+}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                }\PYG{n}{HistorialPaso}\PYG{+w}{ }\PYG{n}{paso}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                }\PYG{n}{itemsDerivacion}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.derivacion.paso}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{ }\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{i}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{: }\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{paso}\PYG{p}{.}\PYG{n+na}{getAccion}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                        }\PYG{n}{listaDerivacion}\PYG{p}{.}\PYG{n+na}{setItems}\PYG{p}{(}\PYG{n}{itemsDerivacion}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                }
\PYG{+w}{                }\PYG{c+c1}{// Actualizar pestaña de árbol si está activa}
\PYG{+w}{                }\PYG{k}{else}\PYG{+w}{ }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{userData}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{arbol\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{simulacionId}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{actualizarContenidoArbol}\PYG{p}{(}\PYG{n}{tab}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{n+nd}{@FXML}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{generarInforme}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{gramatica}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{Alert}\PYG{+w}{ }\PYG{n}{alert}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Alert}\PYG{p}{(}\PYG{n}{Alert}\PYG{p}{.}\PYG{n+na}{AlertType}\PYG{p}{.}\PYG{n+na}{WARNING}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setTitle}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{editor.informe.error.titulo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setHeaderText}\PYG{p}{(}\PYG{k+kc}{null}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setContentText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{editor.informe.error.sin.gramatica}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{showAndWait}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}

\PYG{+w}{        }\PYG{c+c1}{// Crear y configurar el FileChooser}
\PYG{+w}{        }\PYG{n}{FileChooser}\PYG{+w}{ }\PYG{n}{fileChooser}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{FileChooser}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{fileChooser}\PYG{p}{.}\PYG{n+na}{setTitle}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{editor.informe.guardar.titulo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{fileChooser}\PYG{p}{.}\PYG{n+na}{getExtensionFilters}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}
\PYG{+w}{            }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{FileChooser}\PYG{p}{.}\PYG{n+na}{ExtensionFilter}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Documentos PDF}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{*.pdf}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}
\PYG{+w}{        }\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Sugerir nombre de archivo basado en el nombre del archivo fuente}
\PYG{+w}{        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{nombreArchivo}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{gramatica}\PYG{p}{.}\PYG{n+na}{generarNombreArchivoPDF}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacion}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{bundle}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{fileChooser}\PYG{p}{.}\PYG{n+na}{setInitialFileName}\PYG{p}{(}\PYG{n}{nombreArchivo}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// Mostrar diálogo de guardado}
\PYG{+w}{        }\PYG{n}{File}\PYG{+w}{ }\PYG{n}{archivo}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{fileChooser}\PYG{p}{.}\PYG{n+na}{showSaveDialog}\PYG{p}{(}\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{getScene}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getWindow}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{archivo}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{return}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Usuario canceló}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}

\PYG{+w}{        }\PYG{k}{try}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{c+c1}{// Usar la gramática actual para generar el informe}
\PYG{+w}{            }\PYG{n}{Gramatica}\PYG{+w}{ }\PYG{n}{gramaticaOriginal}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{gramatica}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Determinar el estado de la simulación}
\PYG{+w}{            }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{estadoSimulacion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{informe.simulador.no.especificado}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{HistorialPaso}\PYG{+w}{ }\PYG{n}{ultimoPaso}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{n}{historialObservable}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{ultimoPaso}\PYG{p}{.}\PYG{n+na}{getAccion}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.accion.aceptar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{estadoSimulacion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{informe.simulador.estado.aceptada}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{ultimoPaso}\PYG{p}{.}\PYG{n+na}{getAccion}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{equals}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulacionfinal.accion.error}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{estadoSimulacion}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{informe.simulador.estado.rechazada}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Generar el informe del simulador con formato profesional}
\PYG{+w}{            }\PYG{k+kt}{boolean}\PYG{+w}{ }\PYG{n}{exito}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{gramatica}\PYG{p}{.}\PYG{n+na}{generarInformeSimulacionFinalProfesional}\PYG{p}{(}
\PYG{+w}{                }\PYG{n}{archivo}\PYG{p}{.}\PYG{n+na}{getAbsolutePath}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
\PYG{+w}{                }\PYG{n}{gramaticaOriginal}\PYG{p}{,}
\PYG{+w}{                }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{tablaPredictiva}\PYG{p}{,}
\PYG{+w}{                }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{funcionesError}\PYG{p}{,}
\PYG{+w}{                }\PYG{n}{bundle}\PYG{p}{,}
\PYG{+w}{                }\PYG{n}{campoEntrada}\PYG{p}{.}\PYG{n+na}{getText}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
\PYG{+w}{                }\PYG{n}{estadoSimulacion}\PYG{p}{,}
\PYG{+w}{                }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{ArrayList}\PYG{o}{\PYGZlt{}}\PYG{o}{\PYGZgt{}}\PYG{p}{(}\PYG{n}{historialObservable}\PYG{p}{)}
\PYG{+w}{            }\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{exito}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{Alert}\PYG{+w}{ }\PYG{n}{alert}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Alert}\PYG{p}{(}\PYG{n}{Alert}\PYG{p}{.}\PYG{n+na}{AlertType}\PYG{p}{.}\PYG{n+na}{INFORMATION}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setTitle}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{editor.informe.exito.titulo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setHeaderText}\PYG{p}{(}\PYG{k+kc}{null}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setContentText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{editor.informe.exito.mensaje}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZbs{}}\PYG{l+s}{n}\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{archivo}\PYG{p}{.}\PYG{n+na}{getAbsolutePath}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{showAndWait}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{Alert}\PYG{+w}{ }\PYG{n}{alert}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Alert}\PYG{p}{(}\PYG{n}{Alert}\PYG{p}{.}\PYG{n+na}{AlertType}\PYG{p}{.}\PYG{n+na}{ERROR}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setTitle}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{editor.informe.error.titulo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setHeaderText}\PYG{p}{(}\PYG{k+kc}{null}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setContentText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{editor.informe.error.generacion}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{showAndWait}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{catch}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Exception}\PYG{+w}{ }\PYG{n}{e}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{Alert}\PYG{+w}{ }\PYG{n}{alert}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Alert}\PYG{p}{(}\PYG{n}{Alert}\PYG{p}{.}\PYG{n+na}{AlertType}\PYG{p}{.}\PYG{n+na}{ERROR}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setTitle}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{editor.informe.error.titulo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setHeaderText}\PYG{p}{(}\PYG{k+kc}{null}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setContentText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{editor.informe.error.generacion}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZbs{}}\PYG{l+s}{n}\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{e}\PYG{p}{.}\PYG{n+na}{getMessage}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{showAndWait}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{e}\PYG{p}{.}\PYG{n+na}{printStackTrace}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{p}{\PYGZcb{}}\PYG{+w}{ }
\end{MintedVerbatim}

\begin{MintedVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{package}\PYG{+w}{ }\PYG{n+nn}{bienvenida}\PYG{p}{;}

\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{editor.Editor}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{editor.EditorWindow}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{utils.SecondaryWindow}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.application.Application}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.fxml.FXML}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.fxml.FXMLLoader}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.scene.Parent}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.scene.Scene}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.scene.control.*}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.stage.Stage}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{java.awt.Desktop}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{java.io.File}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{java.io.IOException}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{java.util.Locale}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{java.util.ResourceBundle}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{utils.TabManager}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{utils.LanguageItem}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{utils.LanguageListCell}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{utils.ActualizableTextos}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{gramatica.Gramatica}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{simulador.PanelSimuladorDesc}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.scene.input.KeyCode}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.scene.input.KeyCodeCombination}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{javafx.scene.input.KeyCombination}\PYG{p}{;}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{java.util.Map}\PYG{p}{;}

\PYG{k+kd}{public}\PYG{+w}{ }\PYG{k+kd}{class} \PYG{n+nc}{MenuPrincipal}\PYG{+w}{ }\PYG{k+kd}{extends}\PYG{+w}{ }\PYG{n}{Application}\PYG{+w}{ }\PYG{p}{\PYGZob{}}

\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{TabPane}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{mainTab}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Button}\PYG{+w}{ }\PYG{n}{btnCerrarTabs}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{ComboBox}\PYG{o}{\PYGZlt{}}\PYG{n}{LanguageItem}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{comboIdioma}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Button}\PYG{+w}{ }\PYG{n}{btnEditor}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Button}\PYG{+w}{ }\PYG{n}{btnSalir}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Button}\PYG{+w}{ }\PYG{n}{btnSimulador}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Button}\PYG{+w}{ }\PYG{n}{btnAyuda}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Button}\PYG{+w}{ }\PYG{n}{btnTutorial}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Label}\PYG{+w}{ }\PYG{n}{labelTitulo}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Label}\PYG{+w}{ }\PYG{n}{labelSubtitulo}\PYG{p}{;}
\PYG{+w}{    }\PYG{n+nd}{@FXML}\PYG{+w}{ }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Label}\PYG{+w}{ }\PYG{n}{labelDesarrollado}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{lastSelectedTab}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{ResourceBundle}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{;}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Locale}\PYG{+w}{ }\PYG{n}{currentLocale}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Locale}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{es}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{    }\PYG{n+nd}{@Override}
\PYG{+w}{    }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{start}\PYG{p}{(}\PYG{n}{Stage}\PYG{+w}{ }\PYG{n}{primaryStage}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{try}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{c+c1}{// Cargar el FXML}
\PYG{+w}{            }\PYG{n}{FXMLLoader}\PYG{+w}{ }\PYG{n}{loader}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{FXMLLoader}\PYG{p}{(}\PYG{n}{getClass}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getResource}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{/vistas/MenuPrincipal.fxml}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{loader}\PYG{p}{.}\PYG{n+na}{setController}\PYG{p}{(}\PYG{k}{this}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{Parent}\PYG{+w}{ }\PYG{n}{root}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{loader}\PYG{p}{.}\PYG{n+na}{load}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Configurar la escena}
\PYG{+w}{            }\PYG{n}{Scene}\PYG{+w}{ }\PYG{n}{scene}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Scene}\PYG{p}{(}\PYG{n}{root}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{primaryStage}\PYG{p}{.}\PYG{n+na}{setTitle}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{SimAS 3.0}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{primaryStage}\PYG{p}{.}\PYG{n+na}{setScene}\PYG{p}{(}\PYG{n}{scene}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Configurar el tama√±o de la ventana}
\PYG{+w}{            }\PYG{n}{primaryStage}\PYG{p}{.}\PYG{n+na}{setWidth}\PYG{p}{(}\PYG{l+m+mi}{800}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{primaryStage}\PYG{p}{.}\PYG{n+na}{setHeight}\PYG{p}{(}\PYG{l+m+mi}{900}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{primaryStage}\PYG{p}{.}\PYG{n+na}{setMinWidth}\PYG{p}{(}\PYG{l+m+mi}{600}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{primaryStage}\PYG{p}{.}\PYG{n+na}{setMinHeight}\PYG{p}{(}\PYG{l+m+mi}{700}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Configurar atajos de teclado}
\PYG{+w}{            }\PYG{n}{scene}\PYG{p}{.}\PYG{n+na}{getAccelerators}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{put}\PYG{p}{(}
\PYG{+w}{                }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{KeyCodeCombination}\PYG{p}{(}\PYG{n}{KeyCode}\PYG{p}{.}\PYG{n+na}{N}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{KeyCombination}\PYG{p}{.}\PYG{n+na}{SHORTCUT\PYGZus{}DOWN}\PYG{p}{)}\PYG{p}{,}
\PYG{+w}{                }\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{onBtnEditorAction}\PYG{p}{(}\PYG{p}{)}
\PYG{+w}{            }\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{n}{scene}\PYG{p}{.}\PYG{n+na}{getAccelerators}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{put}\PYG{p}{(}
\PYG{+w}{                }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{KeyCodeCombination}\PYG{p}{(}\PYG{n}{KeyCode}\PYG{p}{.}\PYG{n+na}{S}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{KeyCombination}\PYG{p}{.}\PYG{n+na}{SHORTCUT\PYGZus{}DOWN}\PYG{p}{)}\PYG{p}{,}
\PYG{+w}{                }\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{onBtnSimuladorAction}\PYG{p}{(}\PYG{p}{)}
\PYG{+w}{            }\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{n}{scene}\PYG{p}{.}\PYG{n+na}{getAccelerators}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{put}\PYG{p}{(}
\PYG{+w}{                }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{KeyCodeCombination}\PYG{p}{(}\PYG{n}{KeyCode}\PYG{p}{.}\PYG{n+na}{H}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{KeyCombination}\PYG{p}{.}\PYG{n+na}{SHORTCUT\PYGZus{}DOWN}\PYG{p}{)}\PYG{p}{,}
\PYG{+w}{                }\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{onBtnAyudaAction}\PYG{p}{(}\PYG{p}{)}
\PYG{+w}{            }\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{n}{scene}\PYG{p}{.}\PYG{n+na}{getAccelerators}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{put}\PYG{p}{(}
\PYG{+w}{                }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{KeyCodeCombination}\PYG{p}{(}\PYG{n}{KeyCode}\PYG{p}{.}\PYG{n+na}{T}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{KeyCombination}\PYG{p}{.}\PYG{n+na}{SHORTCUT\PYGZus{}DOWN}\PYG{p}{)}\PYG{p}{,}
\PYG{+w}{                }\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{onBtnTutorialAction}\PYG{p}{(}\PYG{p}{)}
\PYG{+w}{            }\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{n}{scene}\PYG{p}{.}\PYG{n+na}{getAccelerators}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{put}\PYG{p}{(}
\PYG{+w}{                }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{KeyCodeCombination}\PYG{p}{(}\PYG{n}{KeyCode}\PYG{p}{.}\PYG{n+na}{Q}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{KeyCombination}\PYG{p}{.}\PYG{n+na}{SHORTCUT\PYGZus{}DOWN}\PYG{p}{)}\PYG{p}{,}
\PYG{+w}{                }\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{onBtnSalirAction}\PYG{p}{(}\PYG{p}{)}
\PYG{+w}{            }\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{n}{scene}\PYG{p}{.}\PYG{n+na}{getAccelerators}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{put}\PYG{p}{(}
\PYG{+w}{                }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{KeyCodeCombination}\PYG{p}{(}\PYG{n}{KeyCode}\PYG{p}{.}\PYG{n+na}{W}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{KeyCombination}\PYG{p}{.}\PYG{n+na}{SHORTCUT\PYGZus{}DOWN}\PYG{p}{)}\PYG{p}{,}
\PYG{+w}{                }\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tabPane}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                        }\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{selectedTab}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getSelectionModel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getSelectedItem}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{selectedTab}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{selectedTab}\PYG{p}{.}\PYG{n+na}{isClosable}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                            }
\PYG{+w}{                            }\PYG{c+c1}{// Get the tab\PYGZsq{}s userData (which contains the editor/simulator ID)}
\PYG{+w}{                            }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{elementId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{selectedTab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{?}\PYG{+w}{ }\PYG{n}{selectedTab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{;}
\PYG{+w}{                            }
\PYG{+w}{                            }\PYG{c+c1}{// Close child tabs first if this is a parent tab}
\PYG{+w}{                            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{elementId}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{closeChildTabs}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{elementId}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                }
\PYG{+w}{                                }\PYG{c+c1}{// Get the group ID before removing the tab}
\PYG{+w}{                                }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{grupoId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{obtenerGrupoDeElemento}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{elementId}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                }
\PYG{+w}{                                }\PYG{c+c1}{// Remove the tab}
\PYG{+w}{                                }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{remove}\PYG{p}{(}\PYG{n}{selectedTab}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                }
\PYG{+w}{                                }\PYG{c+c1}{// Clean up the element from group management}
\PYG{+w}{                                }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{eliminarElementoDeGrupo}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{elementId}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{grupoId}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                }
\PYG{+w}{                                }\PYG{c+c1}{// Force immediate renumbering}
\PYG{+w}{                                }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{reasignarNumerosGruposGramatica}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                            }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                }\PYG{c+c1}{// For non\PYGZhy{}group tabs, just remove them}
\PYG{+w}{                                }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{remove}\PYG{p}{(}\PYG{n}{selectedTab}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Add Ctrl/Cmd+Shift+W shortcut to close all tabs}
\PYG{+w}{            }\PYG{n}{scene}\PYG{p}{.}\PYG{n+na}{getAccelerators}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{put}\PYG{p}{(}
\PYG{+w}{                }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{KeyCodeCombination}\PYG{p}{(}\PYG{n}{KeyCode}\PYG{p}{.}\PYG{n+na}{W}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{KeyCombination}\PYG{p}{.}\PYG{n+na}{SHORTCUT\PYGZus{}DOWN}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{KeyCombination}\PYG{p}{.}\PYG{n+na}{SHIFT\PYGZus{}DOWN}\PYG{p}{)}\PYG{p}{,}
\PYG{+w}{                }\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{onBtnCerrarTabsAction}\PYG{p}{(}\PYG{p}{)}
\PYG{+w}{            }\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Add shortcuts for Cmd/Ctrl + number (1\PYGZhy{}9)}
\PYG{+w}{            }\PYG{n}{KeyCode}\PYG{o}{[}\PYG{o}{]}\PYG{+w}{ }\PYG{n}{numberKeys}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{KeyCode}\PYG{p}{.}\PYG{n+na}{DIGIT0}\PYG{p}{,}\PYG{+w}{ }\PYG{c+c1}{// Add 0 for main menu}
\PYG{+w}{                }\PYG{n}{KeyCode}\PYG{p}{.}\PYG{n+na}{DIGIT1}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{KeyCode}\PYG{p}{.}\PYG{n+na}{DIGIT2}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{KeyCode}\PYG{p}{.}\PYG{n+na}{DIGIT3}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{KeyCode}\PYG{p}{.}\PYG{n+na}{DIGIT4}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{KeyCode}\PYG{p}{.}\PYG{n+na}{DIGIT5}\PYG{p}{,}
\PYG{+w}{                }\PYG{n}{KeyCode}\PYG{p}{.}\PYG{n+na}{DIGIT6}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{KeyCode}\PYG{p}{.}\PYG{n+na}{DIGIT7}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{KeyCode}\PYG{p}{.}\PYG{n+na}{DIGIT8}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{KeyCode}\PYG{p}{.}\PYG{n+na}{DIGIT9}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{n}{numberKeys}\PYG{p}{.}\PYG{n+na}{length}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{o}{+}\PYG{o}{+}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{k+kd}{final}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{groupNumber}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{i}\PYG{p}{;}\PYG{+w}{  }\PYG{c+c1}{// Now starts from 0}
\PYG{+w}{                }\PYG{n}{scene}\PYG{p}{.}\PYG{n+na}{getAccelerators}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{put}\PYG{p}{(}
\PYG{+w}{                    }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{KeyCodeCombination}\PYG{p}{(}\PYG{n}{numberKeys}\PYG{o}{[}\PYG{n}{i}\PYG{o}{]}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{KeyCombination}\PYG{p}{.}\PYG{n+na}{SHORTCUT\PYGZus{}DOWN}\PYG{p}{)}\PYG{p}{,}
\PYG{+w}{                    }\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tabPane}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{groupNumber}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                }\PYG{c+c1}{// For 0, select the main menu (first tab)}
\PYG{+w}{                                }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getSelectionModel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{selectFirst}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                            }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                }\PYG{c+c1}{// For 1\PYGZhy{}9, find the first tab of the specified group}
\PYG{+w}{                                }\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{firstGroupTab}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{findFirstTabInGroup}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{groupNumber}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{firstGroupTab}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                    }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getSelectionModel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{select}\PYG{p}{(}\PYG{n}{firstGroupTab}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                }\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Enable tab dragging and detaching}
\PYG{+w}{            }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{setTabDragPolicy}\PYG{p}{(}\PYG{n}{TabPane}\PYG{p}{.}\PYG{n+na}{TabDragPolicy}\PYG{p}{.}\PYG{n+na}{REORDER}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Configurar el men√∫ contextual para las pesta√±as}
\PYG{+w}{            }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{configurarMenuContextual}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Setup drag and drop handling for tabs}
\PYG{+w}{            }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{setOnDragDetected}\PYG{p}{(}\PYG{n}{event}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{event}\PYG{p}{.}\PYG{n+na}{isShortcutDown}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{+w}{  }\PYG{c+c1}{// Ctrl/Cmd is pressed}
\PYG{+w}{                    }\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{selectedTab}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getSelectionModel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getSelectedItem}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{selectedTab}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{selectedTab}\PYG{p}{.}\PYG{n+na}{isClosable}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                        }\PYG{c+c1}{// Start drag operation}
\PYG{+w}{                        }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{input}\PYG{p}{.}\PYG{n+na}{Dragboard}\PYG{+w}{ }\PYG{n}{db}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{startDragAndDrop}\PYG{p}{(}\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{input}\PYG{p}{.}\PYG{n+na}{TransferMode}\PYG{p}{.}\PYG{n+na}{MOVE}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }
\PYG{+w}{                        }\PYG{c+c1}{// Put a string on dragboard (needed for the drag operation)}
\PYG{+w}{                        }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{input}\PYG{p}{.}\PYG{n+na}{ClipboardContent}\PYG{+w}{ }\PYG{n}{content}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{input}\PYG{p}{.}\PYG{n+na}{ClipboardContent}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }\PYG{n}{content}\PYG{p}{.}\PYG{n+na}{putString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{tab\PYGZhy{}transfer}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }\PYG{n}{db}\PYG{p}{.}\PYG{n+na}{setContent}\PYG{p}{(}\PYG{n}{content}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }
\PYG{+w}{                        }\PYG{c+c1}{// Store the tab temporarily}
\PYG{+w}{                        }\PYG{n}{event}\PYG{p}{.}\PYG{n+na}{consume}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }
\PYG{+w}{                        }\PYG{c+c1}{// Create new window}
\PYG{+w}{                        }\PYG{n}{EditorWindow}\PYG{+w}{ }\PYG{n}{newWindow}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{SecondaryWindow}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{SimAS 3.0}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }
\PYG{+w}{                        }\PYG{c+c1}{// Encontrar el grupo al que pertenece la pesta√±a}
\PYG{+w}{                        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{grupoId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{;}
\PYG{+w}{                        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{selectedTab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                            }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{elementId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{selectedTab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                            }
\PYG{+w}{                            }\PYG{c+c1}{// Si es una pesta√±a de simulaci√≥n, buscar su simulador padre}
\PYG{+w}{                            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{selectedTab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{simulador}\PYG{p}{.}\PYG{n+na}{SimulacionFinal}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                }\PYG{n}{simulador}\PYG{p}{.}\PYG{n+na}{SimulacionFinal}\PYG{+w}{ }\PYG{n}{sim}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{simulador}\PYG{p}{.}\PYG{n+na}{SimulacionFinal}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{selectedTab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{sim}\PYG{p}{.}\PYG{n+na}{perteneceASimulador}\PYG{p}{(}\PYG{n}{sim}\PYG{p}{.}\PYG{n+na}{getSimuladorPadreId}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                    }\PYG{n}{grupoId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{obtenerGrupoDeElemento}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{sim}\PYG{p}{.}\PYG{n+na}{getSimuladorPadreId}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                            }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                }\PYG{c+c1}{// Para otros tipos de pesta√±as}
\PYG{+w}{                                }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{potentialParentId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{elementId}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Inicializar con el ID actual}
\PYG{+w}{                                }
\PYG{+w}{                                }\PYG{c+c1}{// Si es una pesta√±a hija, buscar el ID del padre}
\PYG{+w}{                                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{contains}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{startsWith}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{gramatica\PYGZus{}simulador\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }
\PYG{+w}{                                        }\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{startsWith}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{funciones\PYGZus{}error\PYGZus{}simulador\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                        }\PYG{c+c1}{// Para pesta√±as hijas de simulador}
\PYG{+w}{                                        }\PYG{n}{potentialParentId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{substring}\PYG{p}{(}\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{indexOf}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulador\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                    }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{startsWith}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{creacion\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                        }\PYG{c+c1}{// Para pesta√±as de creaci√≥n}
\PYG{+w}{                                        }\PYG{n}{potentialParentId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{editor\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{substring}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{creacion\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{.}\PYG{n+na}{length}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                    }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{startsWith}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{terminales\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }
\PYG{+w}{                                             }\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{startsWith}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{no\PYGZus{}terminales\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }
\PYG{+w}{                                             }\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{startsWith}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{producciones\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                        }\PYG{c+c1}{// Para pesta√±as de s√≠mbolos}
\PYG{+w}{                                        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{creacionId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{substring}\PYG{p}{(}\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{indexOf}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{creacion\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                        }\PYG{n}{potentialParentId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{editor\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{creacionId}\PYG{p}{.}\PYG{n+na}{substring}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{creacion\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{.}\PYG{n+na}{length}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                    }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{startsWith}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{derivacion\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{startsWith}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{arbol\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                        }\PYG{c+c1}{// Buscar la simulaci√≥n padre}
\PYG{+w}{                                        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{tab}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{simulador}\PYG{p}{.}\PYG{n+na}{SimulacionFinal}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                                }\PYG{n}{simulador}\PYG{p}{.}\PYG{n+na}{SimulacionFinal}\PYG{+w}{ }\PYG{n}{sim}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{simulador}\PYG{p}{.}\PYG{n+na}{SimulacionFinal}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{sim}\PYG{p}{.}\PYG{n+na}{esHijaDeLaSimulacion}\PYG{p}{(}\PYG{n}{selectedTab}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                                    }\PYG{c+c1}{// Encontramos la simulaci√≥n padre, ahora buscar su simulador padre}
\PYG{+w}{                                                    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{sim}\PYG{p}{.}\PYG{n+na}{perteneceASimulador}\PYG{p}{(}\PYG{n}{sim}\PYG{p}{.}\PYG{n+na}{getSimuladorPadreId}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                                        }\PYG{n}{potentialParentId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{sim}\PYG{p}{.}\PYG{n+na}{getSimuladorPadreId}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                                        }\PYG{k}{break}\PYG{p}{;}
\PYG{+w}{                                                    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                                                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                                            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                                        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                                    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                                }
\PYG{+w}{                                }\PYG{c+c1}{// Obtener el grupo usando el ID del padre}
\PYG{+w}{                                }\PYG{n}{grupoId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{obtenerGrupoDeElemento}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{potentialParentId}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                        }
\PYG{+w}{                        }\PYG{c+c1}{// Si la pesta√±a pertenece a un grupo, mover todo el grupo}
\PYG{+w}{                        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{grupoId}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                            }\PYG{n}{newWindow}\PYG{p}{.}\PYG{n+na}{moveGroupToWindow}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{grupoId}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{selectedTab}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                            }\PYG{c+c1}{// Si no pertenece a un grupo, mover solo la pesta√±a}
\PYG{+w}{                            }\PYG{n}{newWindow}\PYG{p}{.}\PYG{n+na}{addTab}\PYG{p}{(}\PYG{n}{selectedTab}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                            }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{remove}\PYG{p}{(}\PYG{n}{selectedTab}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                        }
\PYG{+w}{                        }\PYG{c+c1}{// Show the new window at the cursor position}
\PYG{+w}{                        }\PYG{n}{newWindow}\PYG{p}{.}\PYG{n+na}{show}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }\PYG{n}{Stage}\PYG{+w}{ }\PYG{n}{stage}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Stage}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{newWindow}\PYG{p}{.}\PYG{n+na}{getTabPane}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getScene}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getWindow}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }\PYG{n}{stage}\PYG{p}{.}\PYG{n+na}{setX}\PYG{p}{(}\PYG{n}{event}\PYG{p}{.}\PYG{n+na}{getScreenX}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }\PYG{n}{stage}\PYG{p}{.}\PYG{n+na}{setY}\PYG{p}{(}\PYG{n}{event}\PYG{p}{.}\PYG{n+na}{getScreenY}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{50}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{n}{primaryStage}\PYG{p}{.}\PYG{n+na}{show}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{catch}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{IOException}\PYG{+w}{ }\PYG{n}{e}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{e}\PYG{p}{.}\PYG{n+na}{printStackTrace}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{n+nd}{@FXML}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{initialize}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{c+c1}{// Inicializar idiomas con banderas}
\PYG{+w}{        }\PYG{n}{comboIdioma}\PYG{p}{.}\PYG{n+na}{getItems}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{addAll}\PYG{p}{(}
\PYG{+w}{            }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{LanguageItem}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Espa√±ol}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{es}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{espana.png}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{+w}{            }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{LanguageItem}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{English}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{en}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{england.png}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{+w}{            }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{LanguageItem}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Fran√ßais}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{fr}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{francia.png}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{+w}{            }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{LanguageItem}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Portugu√™s}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{pt}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{portugal.png}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{+w}{            }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{LanguageItem}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Deutsch}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{de}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{alemania.png}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{+w}{            }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{LanguageItem}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Êó•Êú¨Ë™û}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{ja}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{japon.png}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}
\PYG{+w}{        }\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Configurar la celda personalizada para mostrar banderas}
\PYG{+w}{        }\PYG{n}{comboIdioma}\PYG{p}{.}\PYG{n+na}{setCellFactory}\PYG{p}{(}\PYG{n}{param}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{LanguageListCell}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{comboIdioma}\PYG{p}{.}\PYG{n+na}{setButtonCell}\PYG{p}{(}\PYG{k}{new}\PYG{+w}{ }\PYG{n}{LanguageListCell}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Establecer el idioma por defecto (Espa√±ol)}
\PYG{+w}{        }\PYG{n}{comboIdioma}\PYG{p}{.}\PYG{n+na}{setValue}\PYG{p}{(}\PYG{n}{comboIdioma}\PYG{p}{.}\PYG{n+na}{getItems}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{comboIdioma}\PYG{p}{.}\PYG{n+na}{setOnAction}\PYG{p}{(}\PYG{n}{e}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{cambiarIdioma}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{cargarBundle}\PYG{p}{(}\PYG{n}{currentLocale}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Enable tab dragging and detaching}
\PYG{+w}{        }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{setTabDragPolicy}\PYG{p}{(}\PYG{n}{TabPane}\PYG{p}{.}\PYG{n+na}{TabDragPolicy}\PYG{p}{.}\PYG{n+na}{REORDER}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Configurar el men√∫ contextual para las pesta√±as}
\PYG{+w}{        }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{configurarMenuContextual}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Setup drag and drop handling for tabs}
\PYG{+w}{        }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{setOnDragDetected}\PYG{p}{(}\PYG{n}{event}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{event}\PYG{p}{.}\PYG{n+na}{isShortcutDown}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}\PYG{+w}{  }\PYG{c+c1}{// Ctrl/Cmd is pressed}
\PYG{+w}{                }\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{selectedTab}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getSelectionModel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getSelectedItem}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{selectedTab}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{selectedTab}\PYG{p}{.}\PYG{n+na}{isClosable}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{c+c1}{// Start drag operation}
\PYG{+w}{                    }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{input}\PYG{p}{.}\PYG{n+na}{Dragboard}\PYG{+w}{ }\PYG{n}{db}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{startDragAndDrop}\PYG{p}{(}\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{input}\PYG{p}{.}\PYG{n+na}{TransferMode}\PYG{p}{.}\PYG{n+na}{MOVE}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }
\PYG{+w}{                    }\PYG{c+c1}{// Put a string on dragboard (needed for the drag operation)}
\PYG{+w}{                    }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{input}\PYG{p}{.}\PYG{n+na}{ClipboardContent}\PYG{+w}{ }\PYG{n}{content}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{input}\PYG{p}{.}\PYG{n+na}{ClipboardContent}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{n}{content}\PYG{p}{.}\PYG{n+na}{putString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{tab\PYGZhy{}transfer}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{n}{db}\PYG{p}{.}\PYG{n+na}{setContent}\PYG{p}{(}\PYG{n}{content}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }
\PYG{+w}{                    }\PYG{c+c1}{// Store the tab temporarily}
\PYG{+w}{                    }\PYG{n}{event}\PYG{p}{.}\PYG{n+na}{consume}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }
\PYG{+w}{                    }\PYG{c+c1}{// Create new window}
\PYG{+w}{                    }\PYG{n}{EditorWindow}\PYG{+w}{ }\PYG{n}{newWindow}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{SecondaryWindow}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{SimAS 3.0}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }
\PYG{+w}{                    }\PYG{c+c1}{// Encontrar el grupo al que pertenece la pesta√±a}
\PYG{+w}{                    }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{grupoId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{;}
\PYG{+w}{                    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{selectedTab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                        }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{elementId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{selectedTab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }
\PYG{+w}{                        }\PYG{c+c1}{// Si es una pesta√±a de simulaci√≥n, buscar su simulador padre}
\PYG{+w}{                        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{selectedTab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{simulador}\PYG{p}{.}\PYG{n+na}{SimulacionFinal}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                            }\PYG{n}{simulador}\PYG{p}{.}\PYG{n+na}{SimulacionFinal}\PYG{+w}{ }\PYG{n}{sim}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{simulador}\PYG{p}{.}\PYG{n+na}{SimulacionFinal}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{selectedTab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{sim}\PYG{p}{.}\PYG{n+na}{perteneceASimulador}\PYG{p}{(}\PYG{n}{sim}\PYG{p}{.}\PYG{n+na}{getSimuladorPadreId}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                }\PYG{n}{grupoId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{obtenerGrupoDeElemento}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{sim}\PYG{p}{.}\PYG{n+na}{getSimuladorPadreId}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                            }\PYG{c+c1}{// Para otros tipos de pesta√±as}
\PYG{+w}{                            }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{potentialParentId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{elementId}\PYG{p}{;}\PYG{+w}{ }\PYG{c+c1}{// Inicializar con el ID actual}
\PYG{+w}{                            }
\PYG{+w}{                            }\PYG{c+c1}{// Si es una pesta√±a hija, buscar el ID del padre}
\PYG{+w}{                            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{contains}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{startsWith}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{gramatica\PYGZus{}simulador\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }
\PYG{+w}{                                    }\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{startsWith}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{funciones\PYGZus{}error\PYGZus{}simulador\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                    }\PYG{c+c1}{// Para pesta√±as hijas de simulador}
\PYG{+w}{                                    }\PYG{n}{potentialParentId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{substring}\PYG{p}{(}\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{indexOf}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulador\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{startsWith}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{creacion\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                    }\PYG{c+c1}{// Para pesta√±as de creaci√≥n}
\PYG{+w}{                                    }\PYG{n}{potentialParentId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{editor\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{substring}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{creacion\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{.}\PYG{n+na}{length}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{startsWith}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{terminales\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }
\PYG{+w}{                                         }\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{startsWith}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{no\PYGZus{}terminales\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }
\PYG{+w}{                                         }\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{startsWith}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{producciones\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                    }\PYG{c+c1}{// Para pesta√±as de s√≠mbolos}
\PYG{+w}{                                    }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{creacionId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{substring}\PYG{p}{(}\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{indexOf}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{creacion\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                    }\PYG{n}{potentialParentId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{editor\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{creacionId}\PYG{p}{.}\PYG{n+na}{substring}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{creacion\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{.}\PYG{n+na}{length}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{startsWith}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{derivacion\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{|}\PYG{o}{|}\PYG{+w}{ }\PYG{n}{elementId}\PYG{p}{.}\PYG{n+na}{startsWith}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{arbol\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                    }\PYG{c+c1}{// Buscar la simulaci√≥n padre}
\PYG{+w}{                                    }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{tab}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{simulador}\PYG{p}{.}\PYG{n+na}{SimulacionFinal}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                            }\PYG{n}{simulador}\PYG{p}{.}\PYG{n+na}{SimulacionFinal}\PYG{+w}{ }\PYG{n}{sim}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{simulador}\PYG{p}{.}\PYG{n+na}{SimulacionFinal}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{sim}\PYG{p}{.}\PYG{n+na}{esHijaDeLaSimulacion}\PYG{p}{(}\PYG{n}{selectedTab}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                                }\PYG{c+c1}{// Encontramos la simulaci√≥n padre, ahora buscar su simulador padre}
\PYG{+w}{                                                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{sim}\PYG{p}{.}\PYG{n+na}{perteneceASimulador}\PYG{p}{(}\PYG{n}{sim}\PYG{p}{.}\PYG{n+na}{getSimuladorPadreId}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                                                    }\PYG{n}{potentialParentId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{sim}\PYG{p}{.}\PYG{n+na}{getSimuladorPadreId}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                                                    }\PYG{k}{break}\PYG{p}{;}
\PYG{+w}{                                                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                                            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                                        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                                    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                            }
\PYG{+w}{                            }\PYG{c+c1}{// Obtener el grupo usando el ID del padre}
\PYG{+w}{                            }\PYG{n}{grupoId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{obtenerGrupoDeElemento}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{potentialParentId}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                    }
\PYG{+w}{                    }\PYG{c+c1}{// Si la pesta√±a pertenece a un grupo, mover todo el grupo}
\PYG{+w}{                    }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{grupoId}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                        }\PYG{n}{newWindow}\PYG{p}{.}\PYG{n+na}{moveGroupToWindow}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{grupoId}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{selectedTab}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                        }\PYG{c+c1}{// Si no pertenece a un grupo, mover solo la pesta√±a}
\PYG{+w}{                        }\PYG{n}{newWindow}\PYG{p}{.}\PYG{n+na}{addTab}\PYG{p}{(}\PYG{n}{selectedTab}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                        }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{remove}\PYG{p}{(}\PYG{n}{selectedTab}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{                    }
\PYG{+w}{                    }\PYG{c+c1}{// Show the new window at the cursor position}
\PYG{+w}{                    }\PYG{n}{newWindow}\PYG{p}{.}\PYG{n+na}{show}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{n}{Stage}\PYG{+w}{ }\PYG{n}{stage}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Stage}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{newWindow}\PYG{p}{.}\PYG{n+na}{getTabPane}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getScene}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getWindow}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{n}{stage}\PYG{p}{.}\PYG{n+na}{setX}\PYG{p}{(}\PYG{n}{event}\PYG{p}{.}\PYG{n+na}{getScreenX}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                    }\PYG{n}{stage}\PYG{p}{.}\PYG{n+na}{setY}\PYG{p}{(}\PYG{n}{event}\PYG{p}{.}\PYG{n+na}{getScreenY}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{+w}{ }\PYG{l+m+mi}{50}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Actualizar el t√≠tulo inicial de la pesta√±a principal}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{mainTab}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{mainTab}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{title.menu}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Guardar la √∫ltima pesta√±a seleccionada}
\PYG{+w}{        }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getSelectionModel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{selectedItemProperty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{addListener}\PYG{p}{(}\PYG{p}{(}\PYG{n}{obs}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{oldTab}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{newTab}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{newTab}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{lastSelectedTab}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{newTab}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{        }\PYG{c+c1}{// A√±adir listener para detectar cuando se cierran pesta√±as}
\PYG{+w}{        }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{addListener}\PYG{p}{(}\PYG{p}{(}\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{collections}\PYG{p}{.}\PYG{n+na}{ListChangeListener}\PYG{p}{.}\PYG{n+na}{Change}\PYG{o}{\PYGZlt{}}\PYG{o}{?}\PYG{+w}{ }\PYG{k+kd}{extends}\PYG{+w}{ }\PYG{n}{Tab}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{change}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{while}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{change}\PYG{p}{.}\PYG{n+na}{next}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{change}\PYG{p}{.}\PYG{n+na}{wasRemoved}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{c+c1}{// Forzar renumeraci√≥n de grupos cuando se cierra una pesta√±a}
\PYG{+w}{                    }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{reasignarNumerosGruposGramatica}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{cambiarIdioma}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{LanguageItem}\PYG{+w}{ }\PYG{n}{selectedLanguage}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{comboIdioma}\PYG{p}{.}\PYG{n+na}{getValue}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{selectedLanguage}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{currentLocale}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Locale}\PYG{p}{(}\PYG{n}{selectedLanguage}\PYG{p}{.}\PYG{n+na}{getLocale}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{cargarBundle}\PYG{p}{(}\PYG{n}{currentLocale}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{actualizarTextos}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{cargarBundle}\PYG{p}{(}\PYG{n}{Locale}\PYG{+w}{ }\PYG{n}{locale}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{bundle}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{ResourceBundle}\PYG{p}{.}\PYG{n+na}{getBundle}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{utils.messages}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{locale}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{actualizarTextos}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{try}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{c+c1}{// Actualizar ResourceBundle en TabManager}
\PYG{+w}{            }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{setResourceBundle}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Actualizar textos de los botones principales}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnEditor}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{btnEditor}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{btn.editor}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnSalir}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{btnSalir}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{btn.salir}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnSimulador}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{btnSimulador}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{btn.simulador}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnAyuda}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{btnAyuda}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{btn.ayuda}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnTutorial}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{btnTutorial}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{btn.tutorial}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnCerrarTabs}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{btnCerrarTabs}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{‚úñ}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{btnCerrarTabs}\PYG{p}{.}\PYG{n+na}{getTooltip}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{tooltip.cerrar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Actualizar textos de las etiquetas}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{comboIdioma}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{comboIdioma}\PYG{p}{.}\PYG{n+na}{getParent}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{Label}\PYG{+w}{ }\PYG{n}{labelIdioma}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Label}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{comboIdioma}\PYG{p}{.}\PYG{n+na}{getParent}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{getChildrenUnmodifiable}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{labelIdioma}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{label.idioma}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{labelTitulo}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{labelTitulo}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{label.titulo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{labelSubtitulo}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{labelSubtitulo}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{label.subtitulo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{labelDesarrollado}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{labelDesarrollado}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{label.desarrollado}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Actualizar el t√≠tulo de la pesta√±a principal}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{mainTab}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{mainTab}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{title.menu}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Actualizar textos de las pesta√±as y contenido}
\PYG{+w}{            }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{tab}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{instanceof}\PYG{+w}{ }\PYG{n}{ActualizableTextos}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{p}{(}\PYG{p}{(}\PYG{n}{ActualizableTextos}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getContent}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{actualizarTextos}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Actualizar t√≠tulos de pesta√±as}
\PYG{+w}{            }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{actualizarTitulosPesta√±as}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// SINCRONIZAR IDIOMA CON TODAS LAS VENTANAS SECUNDARIAS}
\PYG{+w}{            }\PYG{n}{sincronizarIdiomaConVentanasSecundarias}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// ACTUALIZAR TODOS LOS SIMULADORES ACTIVOS}
\PYG{+w}{            }\PYG{n}{actualizarTodosLosSimuladores}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{catch}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Exception}\PYG{+w}{ }\PYG{n}{e}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{e}\PYG{p}{.}\PYG{n+na}{printStackTrace}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Sincroniza el idioma actual con todas las ventanas secundarias activas}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{sincronizarIdiomaConVentanasSecundarias}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{Map}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{SecondaryWindow}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{activeWindows}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{SecondaryWindow}\PYG{p}{.}\PYG{n+na}{getActiveWindows}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{SecondaryWindow}\PYG{+w}{ }\PYG{n}{window}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{activeWindows}\PYG{p}{.}\PYG{n+na}{values}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{window}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{window}\PYG{p}{.}\PYG{n+na}{getStage}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{+w}{ }\PYG{o}{\PYGZam{}}\PYG{o}{\PYGZam{}}\PYG{+w}{ }\PYG{n}{window}\PYG{p}{.}\PYG{n+na}{getStage}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{isShowing}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{c+c1}{// Actualizar el ResourceBundle de la ventana secundaria}
\PYG{+w}{                }\PYG{n}{window}\PYG{p}{.}\PYG{n+na}{actualizarIdioma}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Actualiza el bundle de todos los simuladores activos}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{actualizarTodosLosSimuladores}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{c+c1}{// Usar el nuevo m√©todo est√°tico para actualizar todos los simuladores}
\PYG{+w}{        }\PYG{n}{simulador}\PYG{p}{.}\PYG{n+na}{PanelSimuladorDesc}\PYG{p}{.}\PYG{n+na}{actualizarTodosLosSimuladores}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{n+nd}{@FXML}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{onBtnCerrarTabsAction}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{ButtonType}\PYG{+w}{ }\PYG{n}{btnCerrar}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{ButtonType}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{btn.cerrar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{ButtonBar}\PYG{p}{.}\PYG{n+na}{ButtonData}\PYG{p}{.}\PYG{n+na}{YES}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{ButtonType}\PYG{+w}{ }\PYG{n}{btnCancelar}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{ButtonType}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{button.cancelar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{ButtonBar}\PYG{p}{.}\PYG{n+na}{ButtonData}\PYG{p}{.}\PYG{n+na}{NO}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{Alert}\PYG{+w}{ }\PYG{n}{confirm}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Alert}\PYG{p}{(}\PYG{n}{Alert}\PYG{p}{.}\PYG{n+na}{AlertType}\PYG{p}{.}\PYG{n+na}{CONFIRMATION}\PYG{p}{,}
\PYG{+w}{                }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{msg.confirmar.cerrar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{+w}{                }\PYG{n}{btnCerrar}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{btnCancelar}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{confirm}\PYG{p}{.}\PYG{n+na}{setTitle}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{title.cerrar.pestanas}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{confirm}\PYG{p}{.}\PYG{n+na}{setHeaderText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{title.cerrar.pestanas}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{n}{confirm}\PYG{p}{.}\PYG{n+na}{showAndWait}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{ifPresent}\PYG{p}{(}\PYG{n}{response}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{response}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{n}{btnCerrar}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getSelectionModel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{selectFirst}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{removeIf}\PYG{p}{(}\PYG{n}{Tab}\PYG{p}{:}\PYG{p}{:}\PYG{n}{isClosable}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{c+c1}{// Reiniciar la numeraci√≥n de grupos}
\PYG{+w}{                }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{resetGrupos}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{lastSelectedTab}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getSelectionModel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{select}\PYG{p}{(}\PYG{n}{lastSelectedTab}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{n+nd}{@FXML}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{onBtnEditorAction}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{c+c1}{// Establecer el ResourceBundle en TabManager para internacionalizaci√≥n}
\PYG{+w}{        }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{setResourceBundle}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Crear un nuevo editor usando TabManager para posicionamiento correcto}
\PYG{+w}{        }\PYG{n}{Editor}\PYG{+w}{ }\PYG{n}{editor}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Editor}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{k}{this}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// CREAR NUEVO GRUPO: Editor independiente desde men√∫ principal}
\PYG{+w}{        }\PYG{c+c1}{// parentId = editorId, childId = null ‚Üí Esto crear√° un NUEVO GRUPO autom√°ticamente}
\PYG{+w}{        }\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{editorTab}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{getOrCreateTab}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{Editor}\PYG{p}{.}\PYG{n+na}{class}\PYG{p}{,}\PYG{+w}{ }
\PYG{+w}{            }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{editor.title}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{editor}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{editor}\PYG{p}{.}\PYG{n+na}{getEditorId}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Asegurar que el editorId est√© configurado como userData}
\PYG{+w}{        }\PYG{n}{editorTab}\PYG{p}{.}\PYG{n+na}{setUserData}\PYG{p}{(}\PYG{n}{editor}\PYG{p}{.}\PYG{n+na}{getEditorId}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Reasignar numeraci√≥n para reflejar los cambios}
\PYG{+w}{        }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{reasignarNumerosGruposGramatica}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{n+nd}{@FXML}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{onBtnAyudaAction}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{File}\PYG{+w}{ }\PYG{n}{manual}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{File}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{ManualDeUsuario.pdf}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{manual}\PYG{p}{.}\PYG{n+na}{exists}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{try}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Desktop}\PYG{p}{.}\PYG{n+na}{isDesktopSupported}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{Desktop}\PYG{p}{.}\PYG{n+na}{getDesktop}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{open}\PYG{p}{(}\PYG{n}{manual}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{onMostrarErrorAction}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{msg.error.escritorio}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{catch}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{IOException}\PYG{+w}{ }\PYG{n}{e}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{onMostrarErrorAction}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{msg.error.manual}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{: }\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{e}\PYG{p}{.}\PYG{n+na}{getMessage}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{onMostrarErrorAction}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{msg.error.archivo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{n+nd}{@FXML}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{onBtnTutorialAction}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{File}\PYG{+w}{ }\PYG{n}{tutorial}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{File}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{src/centroayuda/SimAS.html}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tutorial}\PYG{p}{.}\PYG{n+na}{exists}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{try}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Desktop}\PYG{p}{.}\PYG{n+na}{isDesktopSupported}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{Desktop}\PYG{p}{.}\PYG{n+na}{getDesktop}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{browse}\PYG{p}{(}\PYG{n}{tutorial}\PYG{p}{.}\PYG{n+na}{toURI}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{n}{onMostrarErrorAction}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{msg.error.escritorio}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{catch}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{IOException}\PYG{+w}{ }\PYG{n}{e}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{onMostrarErrorAction}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{msg.error.tutorial}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{: }\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{e}\PYG{p}{.}\PYG{n+na}{getMessage}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{onMostrarErrorAction}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{msg.error.archivo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{n+nd}{@FXML}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{onBtnSimuladorAction}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{c+c1}{// Implementar funcionalidad del simulador descendente directo}
\PYG{+w}{        }\PYG{n}{cargarGramaticaYSimularDirectamente}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Carga una gram√°tica desde archivo y va directamente al paso 6 de la simulaci√≥n.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{cargarGramaticaYSimularDirectamente}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{try}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{c+c1}{// Crear una nueva gram√°tica}
\PYG{+w}{            }\PYG{n}{Gramatica}\PYG{+w}{ }\PYG{n}{nuevaGramatica}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Gramatica}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Cargar gram√°tica desde archivo (esto abrir√° el selector de archivos)}
\PYG{+w}{            }\PYG{n}{Gramatica}\PYG{+w}{ }\PYG{n}{gramaticaCargada}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{nuevaGramatica}\PYG{p}{.}\PYG{n+na}{cargarGramatica}\PYG{p}{(}\PYG{k+kc}{null}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{gramaticaCargada}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{c+c1}{// Validar la gram√°tica cargada}
\PYG{+w}{                }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{collections}\PYG{p}{.}\PYG{n+na}{ObservableList}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{errores}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{gramaticaCargada}\PYG{p}{.}\PYG{n+na}{validarGramatica}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{gramaticaCargada}\PYG{p}{.}\PYG{n+na}{getEstado}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{c+c1}{// Gram√°tica v√°lida \PYGZhy{} proceder con la simulaci√≥n}
\PYG{+w}{                    }\PYG{n}{crearSimuladorDirectoAlPaso6}\PYG{p}{(}\PYG{n}{gramaticaCargada}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{else}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{c+c1}{// Gram√°tica inv√°lida \PYGZhy{} mostrar errores}
\PYG{+w}{                    }\PYG{n}{mostrarErroresValidacion}\PYG{p}{(}\PYG{n}{errores}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{c+c1}{// Si gramaticaCargada es null, significa que el usuario cancel√≥ la selecci√≥n}
\PYG{+w}{            }
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{catch}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Exception}\PYG{+w}{ }\PYG{n}{e}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{e}\PYG{p}{.}\PYG{n+na}{printStackTrace}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{mostrarError}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Error}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{No se pudo cargar la gram√°tica: }\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{e}\PYG{p}{.}\PYG{n+na}{getMessage}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Crea un simulador y lo lleva directamente al paso 6.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{crearSimuladorDirectoAlPaso6}\PYG{p}{(}\PYG{n}{Gramatica}\PYG{+w}{ }\PYG{n}{gramatica}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{try}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{c+c1}{// Establecer el ResourceBundle en TabManager para internacionalizaci√≥n}
\PYG{+w}{            }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{setResourceBundle}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Generar ID √∫nico para el simulador}
\PYG{+w}{            }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{simuladorId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulador\PYGZus{}}\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{System}\PYG{p}{.}\PYG{n+na}{currentTimeMillis}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// ASIGNAR A NUEVO GRUPO ANTES de crear la pesta√±a: Simulador independiente desde men√∫ principal}
\PYG{+w}{            }\PYG{c+c1}{// Esto asegura que la numeraci√≥n y posicionamiento sean correctos}
\PYG{+w}{            }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{asignarElementoANuevoGrupo}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{simuladorId}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Crear una copia de la gram√°tica para el simulador (para no modificar la original)}
\PYG{+w}{            }\PYG{n}{Gramatica}\PYG{+w}{ }\PYG{n}{gramaticaParaSimulador}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Gramatica}\PYG{p}{(}\PYG{n}{gramatica}\PYG{p}{)}\PYG{p}{;}

\PYG{+w}{            }\PYG{c+c1}{// Crear el simulador descendente con la copia de la gram√°tica}
\PYG{+w}{            }\PYG{n}{PanelSimuladorDesc}\PYG{+w}{ }\PYG{n}{simulador}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{PanelSimuladorDesc}\PYG{p}{(}\PYG{n}{gramaticaParaSimulador}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{simuladorId}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Crear la pesta√±a del simulador con el t√≠tulo correcto}
\PYG{+w}{            }\PYG{c+c1}{// Como vamos directamente al paso 6, usamos el t√≠tulo de simulador}
\PYG{+w}{            }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{tituloBase}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{simulador.tab.paso6}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{numeroGrupo}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{obtenerNumeroGrupo}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{simuladorId}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{tituloFinal}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{numeroGrupo}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{+w}{ }\PYG{o}{?}\PYG{+w}{ }\PYG{n}{numeroGrupo}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZhy{}}\PYG{l+s}{\PYGZdq{}}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{n}{tituloBase}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{tituloBase}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Crear la pesta√±a usando TabManager}
\PYG{+w}{            }\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{pesta√±aSimulador}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{getOrCreateTab}\PYG{p}{(}
\PYG{+w}{                }\PYG{n}{tabPane}\PYG{p}{,}
\PYG{+w}{                }\PYG{n}{PanelSimuladorDesc}\PYG{p}{.}\PYG{n+na}{class}\PYG{p}{,}
\PYG{+w}{                }\PYG{n}{tituloFinal}\PYG{p}{,}
\PYG{+w}{                }\PYG{n}{simulador}\PYG{p}{,}
\PYG{+w}{                }\PYG{n}{simuladorId}\PYG{p}{,}
\PYG{+w}{                }\PYG{k+kc}{null}
\PYG{+w}{            }\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Establecer la pesta√±a en el simulador}
\PYG{+w}{            }\PYG{n}{simulador}\PYG{p}{.}\PYG{n+na}{setPesta√±aSimulacion}\PYG{p}{(}\PYG{n}{pesta√±aSimulador}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Asegurarse de que la pesta√±a est√© seleccionada}
\PYG{+w}{            }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getSelectionModel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{select}\PYG{p}{(}\PYG{n}{pesta√±aSimulador}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Ahora s√≠, saltar directamente al paso 6 (√≠ndice 5)}
\PYG{+w}{            }\PYG{n}{simulador}\PYG{p}{.}\PYG{n+na}{cambiarPaso}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }
\PYG{+w}{            }\PYG{c+c1}{// Reasignar numeraci√≥n para reflejar los cambios}
\PYG{+w}{            }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{reasignarNumerosGruposGramatica}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{+w}{ }\PYG{k}{catch}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Exception}\PYG{+w}{ }\PYG{n}{e}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{e}\PYG{p}{.}\PYG{n+na}{printStackTrace}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Muestra los errores de validaci√≥n de la gram√°tica.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{mostrarErroresValidacion}\PYG{p}{(}\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{collections}\PYG{p}{.}\PYG{n+na}{ObservableList}\PYG{o}{\PYGZlt{}}\PYG{n}{String}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{errores}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{StringBuilder}\PYG{+w}{ }\PYG{n}{mensaje}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{StringBuilder}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{editor.msg.validar.errores}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZbs{}}\PYG{l+s}{n}\PYG{l+s}{\PYGZbs{}}\PYG{l+s}{n}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{+w}{ }\PYG{o}{\PYGZlt{}}\PYG{+w}{ }\PYG{n}{errores}\PYG{p}{.}\PYG{n+na}{size}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}\PYG{+w}{ }\PYG{n}{i}\PYG{o}{+}\PYG{o}{+}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{n}{mensaje}\PYG{p}{.}\PYG{n+na}{append}\PYG{p}{(}\PYG{n}{i}\PYG{+w}{ }\PYG{o}{+}\PYG{+w}{ }\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{append}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{. }\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{append}\PYG{p}{(}\PYG{n}{errores}\PYG{p}{.}\PYG{n+na}{get}\PYG{p}{(}\PYG{n}{i}\PYG{p}{)}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{append}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{\PYGZbs{}}\PYG{l+s}{n}\PYG{l+s}{\PYGZbs{}}\PYG{l+s}{n}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{n}{Alert}\PYG{+w}{ }\PYG{n}{alert}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Alert}\PYG{p}{(}\PYG{n}{Alert}\PYG{p}{.}\PYG{n+na}{AlertType}\PYG{p}{.}\PYG{n+na}{ERROR}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setTitle}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Error de Validaci√≥n}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setHeaderText}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{La gram√°tica seleccionada contiene errores}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setContentText}\PYG{p}{(}\PYG{n}{mensaje}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{c+c1}{// Expandir el di√°logo para mostrar todo el texto}
\PYG{+w}{        }\PYG{n}{TextArea}\PYG{+w}{ }\PYG{n}{textArea}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{TextArea}\PYG{p}{(}\PYG{n}{mensaje}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{textArea}\PYG{p}{.}\PYG{n+na}{setEditable}\PYG{p}{(}\PYG{k+kc}{false}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{textArea}\PYG{p}{.}\PYG{n+na}{setWrapText}\PYG{p}{(}\PYG{k+kc}{true}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{textArea}\PYG{p}{.}\PYG{n+na}{setMaxWidth}\PYG{p}{(}\PYG{n}{Double}\PYG{p}{.}\PYG{n+na}{MAX\PYGZus{}VALUE}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{textArea}\PYG{p}{.}\PYG{n+na}{setMaxHeight}\PYG{p}{(}\PYG{n}{Double}\PYG{p}{.}\PYG{n+na}{MAX\PYGZus{}VALUE}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{layout}\PYG{p}{.}\PYG{n+na}{GridPane}\PYG{p}{.}\PYG{n+na}{setVgrow}\PYG{p}{(}\PYG{n}{textArea}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{layout}\PYG{p}{.}\PYG{n+na}{Priority}\PYG{p}{.}\PYG{n+na}{ALWAYS}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{layout}\PYG{p}{.}\PYG{n+na}{GridPane}\PYG{p}{.}\PYG{n+na}{setHgrow}\PYG{p}{(}\PYG{n}{textArea}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{layout}\PYG{p}{.}\PYG{n+na}{Priority}\PYG{p}{.}\PYG{n+na}{ALWAYS}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{layout}\PYG{p}{.}\PYG{n+na}{GridPane}\PYG{+w}{ }\PYG{n}{gridPane}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{javafx}\PYG{p}{.}\PYG{n+na}{scene}\PYG{p}{.}\PYG{n+na}{layout}\PYG{p}{.}\PYG{n+na}{GridPane}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{gridPane}\PYG{p}{.}\PYG{n+na}{setMaxWidth}\PYG{p}{(}\PYG{n}{Double}\PYG{p}{.}\PYG{n+na}{MAX\PYGZus{}VALUE}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{gridPane}\PYG{p}{.}\PYG{n+na}{add}\PYG{p}{(}\PYG{n}{textArea}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{+w}{ }\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }
\PYG{+w}{        }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{getDialogPane}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{setExpandableContent}\PYG{p}{(}\PYG{n}{gridPane}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{showAndWait}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{+w}{    }
\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Muestra un mensaje de error simple.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{mostrarError}\PYG{p}{(}\PYG{n}{String}\PYG{+w}{ }\PYG{n}{titulo}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{mensaje}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{Alert}\PYG{+w}{ }\PYG{n}{alert}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Alert}\PYG{p}{(}\PYG{n}{Alert}\PYG{p}{.}\PYG{n+na}{AlertType}\PYG{p}{.}\PYG{n+na}{ERROR}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setTitle}\PYG{p}{(}\PYG{n}{titulo}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setHeaderText}\PYG{p}{(}\PYG{k+kc}{null}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{setContentText}\PYG{p}{(}\PYG{n}{mensaje}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{alert}\PYG{p}{.}\PYG{n+na}{showAndWait}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{n+nd}{@FXML}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{onMostrarErrorAction}\PYG{p}{(}\PYG{n}{String}\PYG{+w}{ }\PYG{n}{mensaje}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{Alert}\PYG{+w}{ }\PYG{n}{alerta}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Alert}\PYG{p}{(}\PYG{n}{Alert}\PYG{p}{.}\PYG{n+na}{AlertType}\PYG{p}{.}\PYG{n+na}{ERROR}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{mensaje}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{ButtonType}\PYG{p}{.}\PYG{n+na}{OK}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{alerta}\PYG{p}{.}\PYG{n+na}{setTitle}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Error}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{alerta}\PYG{p}{.}\PYG{n+na}{setHeaderText}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Error al abrir el archivo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{alerta}\PYG{p}{.}\PYG{n+na}{showAndWait}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{n+nd}{@FXML}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{onBtnSalirAction}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{Alert}\PYG{+w}{ }\PYG{n}{confirm}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Alert}\PYG{p}{(}\PYG{n}{Alert}\PYG{p}{.}\PYG{n+na}{AlertType}\PYG{p}{.}\PYG{n+na}{CONFIRMATION}\PYG{p}{,}
\PYG{+w}{                }\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{msg.confirmar.salir}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{+w}{                }\PYG{n}{ButtonType}\PYG{p}{.}\PYG{n+na}{YES}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{ButtonType}\PYG{p}{.}\PYG{n+na}{NO}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{confirm}\PYG{p}{.}\PYG{n+na}{setTitle}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{title.menu}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{confirm}\PYG{p}{.}\PYG{n+na}{showAndWait}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{ifPresent}\PYG{p}{(}\PYG{n}{response}\PYG{+w}{ }\PYG{o}{\PYGZhy{}}\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{response}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{n}{ButtonType}\PYG{p}{.}\PYG{n+na}{YES}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{System}\PYG{p}{.}\PYG{n+na}{exit}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{n+nd}{@FXML}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{onBtnInfoAction}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{n}{Alert}\PYG{+w}{ }\PYG{n}{acercaDe}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{k}{new}\PYG{+w}{ }\PYG{n}{Alert}\PYG{p}{(}\PYG{n}{Alert}\PYG{p}{.}\PYG{n+na}{AlertType}\PYG{p}{.}\PYG{n+na}{INFORMATION}\PYG{p}{,}
\PYG{+w}{                }\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{SimAS 3.0}\PYG{l+s}{\PYGZbs{}}\PYG{l+s}{nDesarrollado por Antonio.}\PYG{l+s}{\PYGZdq{}}\PYG{p}{,}
\PYG{+w}{                }\PYG{n}{ButtonType}\PYG{p}{.}\PYG{n+na}{OK}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{acercaDe}\PYG{p}{.}\PYG{n+na}{setTitle}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{Acerca de}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{acercaDe}\PYG{p}{.}\PYG{n+na}{showAndWait}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{setBundle}\PYG{p}{(}\PYG{n}{ResourceBundle}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{this}\PYG{p}{.}\PYG{n+na}{bundle}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{;}
\PYG{+w}{        }\PYG{n}{actualizarTextos}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{actualizarTextos}\PYG{p}{(}\PYG{n}{ResourceBundle}\PYG{+w}{ }\PYG{n}{bundle}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{labelTitulo}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{labelTitulo}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{label.titulo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{labelSubtitulo}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{labelSubtitulo}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{label.subtitulo}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{labelDesarrollado}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{labelDesarrollado}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{label.desarrollado}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnEditor}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{btnEditor}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{btn.editor}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnSimulador}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{btnSimulador}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{btn.simulador}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnAyuda}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{btnAyuda}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{btn.ayuda}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnTutorial}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{btnTutorial}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{btn.tutorial}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnSalir}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{btnSalir}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{btn.salir}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{btnCerrarTabs}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{n}{btnCerrarTabs}\PYG{p}{.}\PYG{n+na}{setText}\PYG{p}{(}\PYG{n}{bundle}\PYG{p}{.}\PYG{n+na}{getString}\PYG{p}{(}\PYG{l+s}{\PYGZdq{}}\PYG{l+s}{btn.cerrar}\PYG{l+s}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{k+kd}{public}\PYG{+w}{ }\PYG{k+kd}{static}\PYG{+w}{ }\PYG{k+kt}{void}\PYG{+w}{ }\PYG{n+nf}{reasignarNumerosSimulaciones}\PYG{p}{(}\PYG{n}{TabPane}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tabPane}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{k}{return}\PYG{p}{;}
\PYG{+w}{        }\PYG{c+c1}{// ... (resto del c√≥digo igual, pero usando el tabPane recibido)}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}

\PYG{+w}{    }\PYG{c+cm}{/**}
\PYG{c+cm}{     * Finds the first tab belonging to the specified group number.}
\PYG{c+cm}{     */}
\PYG{+w}{    }\PYG{k+kd}{private}\PYG{+w}{ }\PYG{n}{Tab}\PYG{+w}{ }\PYG{n+nf}{findFirstTabInGroup}\PYG{p}{(}\PYG{n}{TabPane}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{groupNumber}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{        }\PYG{c+c1}{// First, find all tabs in the specified group}
\PYG{+w}{        }\PYG{k}{for}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{Tab}\PYG{+w}{ }\PYG{n}{tab}\PYG{+w}{ }\PYG{p}{:}\PYG{+w}{ }\PYG{n}{tabPane}\PYG{p}{.}\PYG{n+na}{getTabs}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{            }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{+w}{ }\PYG{o}{!}\PYG{o}{=}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                }\PYG{n}{String}\PYG{+w}{ }\PYG{n}{elementId}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{.}\PYG{n+na}{getUserData}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+na}{toString}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{c+c1}{// Get the group number for this tab}
\PYG{+w}{                }\PYG{k+kt}{int}\PYG{+w}{ }\PYG{n}{tabGroupNumber}\PYG{+w}{ }\PYG{o}{=}\PYG{+w}{ }\PYG{n}{TabManager}\PYG{p}{.}\PYG{n+na}{obtenerNumeroGrupo}\PYG{p}{(}\PYG{n}{tabPane}\PYG{p}{,}\PYG{+w}{ }\PYG{n}{elementId}\PYG{p}{)}\PYG{p}{;}
\PYG{+w}{                }\PYG{k}{if}\PYG{+w}{ }\PYG{p}{(}\PYG{n}{tabGroupNumber}\PYG{+w}{ }\PYG{o}{=}\PYG{o}{=}\PYG{+w}{ }\PYG{n}{groupNumber}\PYG{p}{)}\PYG{+w}{ }\PYG{p}{\PYGZob{}}
\PYG{+w}{                    }\PYG{k}{return}\PYG{+w}{ }\PYG{n}{tab}\PYG{p}{;}
\PYG{+w}{                }\PYG{p}{\PYGZcb{}}
\PYG{+w}{            }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{p}{\PYGZcb{}}
\PYG{+w}{        }\PYG{k}{return}\PYG{+w}{ }\PYG{k+kc}{null}\PYG{p}{;}
\PYG{+w}{    }\PYG{p}{\PYGZcb{}}
\PYG{p}{\PYGZcb{}}
\end{MintedVerbatim}
